import{browser_ as e,OnFirefox as t,post_ as r}from"./async_bg.js";import{bgSettings_ as s,Option_ as n,oTrans_ as i}from"./options_base.js";let l=/\s/g,a=(e,t)=>{let r=0,s=e.length,n=t;for(;n<s;n++)switch(e[n]){case"{":case"[":r++;break;case"]":case"}":if(--r,r>0)break;default:{let t=('"'===e[n]?/^"([^"\\]|\\[^])*"/:r>0?/^(?:[$a-zA-Z_][$\w]*|\d[\d.eE+-]|\s+)/:/^\S+/).exec(e.slice(n));if(!t&&!r&&/\s/.test(e[n]))return n;n+=t?t[0].length-1:0}}if(r>0){let r=/^\S*/.exec(e.slice(t));return t+(r?r[0].length:0)}return n},u={n:0,i:null,R(){function e(e,t,r){let s="";r.length>2&&":"===r[r.length-2]&&(s=r.slice(-2),r=r.slice(0,-2)),t=t.toLowerCase();let n=r.length>1,i=t.includes("s-"),l=r.toUpperCase();if(!n){if(!t)return e;if(i&&t.length<3)return s?`<${l}${s}>`:l}if(t.includes("v-"))return`<v-${r}>`;let a=r.toLowerCase();var u;return t=(u=t).length<4?u:u.slice(0,-1).split("-").sort().join("-")+"-",r!==a&&!i&&(t+="s-"),t||n||s?`<${t}${a}${s}>`:r}this.i=t=>t.replace(/<(?!<)((?:[ACMSVacmsv]-){0,4})(.[^>]*)>/g,e),this.R=null},l:(e,t)=>t?"\\u00"+t:"\\\\",c(e){let t=e.slice(1),r="",s="";t.startsWith('"')&&t.endsWith('"')?(r=t.slice(1,-1),r=r.replace(/\\(?:x([\da-z]{2})|\\)/gi,u.l),t=`"${r}"`):t&&"{[".includes(t[0])&&(t=t.replace(/([{,](?: |\x7f\d*\x80)*)(\w+):|"(?:[^"\\]|\\[^])*"/g,(e,t,r)=>t?`${t}"${r}":`:e),s=t);let n=t.includes("\x7f"),i=n&&!r?(/^(?:\x7f\d*\x80)+/.exec(t)||[""])[0]:"",a=!n||r?"":(/(?:\x7f\d*\x80)+$/.exec(t.slice(i.length+1))||[""])[0];try{let r=JSON.parse(n?t.replace(/\x7f\d*\x80/g,""):t);if("string"!=typeof r&&!/\s/.test(t))return true===r?"":s?"="+s:e;t=n?JSON.parse(t.slice(i.length,a?-a.length:void 0)):r}catch(e){t=n?r||t.slice(i.length,a?-a.length:void 0):r||t}return t=t&&"string"==typeof t?t.replace(/\\(\\|s)/g,(e,t)=>"s"===t?" ":e):t,t=t&&JSON.stringify(t).replace(l,u.d),"="+i+t+a},d:e=>"\\u"+(e.charCodeAt(0)+1048576).toString(16).slice(2),ee(e,t,r,s,n){let i=u.i(s);if(i!==s&&(console.log("KeyMappings Checker:",s,"is corrected into",i),s=i),"mapkey"===r.toLowerCase()){let e=/^\S+/.exec(n.trimLeft()),t=e&&e[0],r=t&&u.i(t);r!==t&&(console.log("KeyMappings Checker:",t,"is corrected into",r),n=n.replace(t,r))}else if(!r.startsWith("unmap")){let e=n.trimLeft().split(/\s/,1)[0];if(e){let t=n.indexOf(e)+e.length;s+=n.slice(0,t),n=n.slice(t)}}return u.te("",t,s,n)},re:(e,t,r)=>t.replace("map","mapKey")+(3===r.length?r[1]:r),te(e,t,r,s){if(/\s(createTab|openUrl)/.test(r)&&!/\surls?=/i.test(s)&&(s=u.se(s)),!s)return t+r;let n=0,i=-1,o="";for(;i<s.length&&(i=s.indexOf("=",i+1),o+=s.slice(n,i>=0?i:void 0),!(i<0));){let e=i+1;if(e<s.length&&'"[{'.includes(s[e]))e=a(s,e);else{l.lastIndex=i;let t=l.exec(s);e=t?t.index:s.length}o+=u.c(s.slice(i,e)),n=i=e}return t+r+o},se(e){let t=[];e=(e+" ").replace(/\s+(\w+:[^=\s]+|[^\s=]+:\/\/\S+)(?=\s|$)/g,(e,r)=>(t.push(r),"")).trimRight();let r=t.length;return e+(r>1?" urls=":r?" url=":"")+(r?JSON.stringify(r>1?t:t[0]):"")},T(e){return e?(this.R&&this.R(),e=(e=(e=(e=(e=(e=e.replace(/\\(?:\n|\\\n[^\S\n]*)/g,e=>"\n"===e[1]?"\x7f\x80":`\x7f${e.length-3}\x80`)).replace(/^([ \t]*(?:#\s?)?map\s+(?:<(?!<)(?:.-){0,4}.[\w:]*?>|\S)\s+)(<(?!<)(?:[ACMSVacmsv]-){0,4}.\w*?>|\S)(?=\s|$)/gm,this.re)).replace(/^([ \t]*(?:#\s?)?(map(?:[kK]ey|!)?|run!?|unmap!?)\s+)(\S+)([^\n]*)/gm,this.ee)).replace(/^([ \t]*(?:#\s?)?(?:command|shortcut)\s+)(\S+)([^\n]*)/gm,this.te)).replace(/\x7f(\d*)\x80/g,(e,t)=>""===t?"\\\n":"\\\\\n"+" ".repeat(+t))).replace(/\\(?:\n|\\\n\s*)$/,"").trim()):e}};n.D.keyMappings.P=u,n.D.searchUrl.P={n:0,T(e){return r(14,e).then(e=>{let t=n.D.searchUrl;if(null==e)return t.E();let r=e[1];if(!e[0]){let e=i("nonPlainURL",[r]);return console.log("searchUrl checker:",e),t.ne(e),t.E()}return t.ne(""),r})}},n.D.newTabUrl.P={n:0,T(t){return r(13,/^\/?pages\/[a-z]+.html\b/i.test(t)?e.runtime.getURL(t):t.toLowerCase()).then(([e,r])=>(e=e.split("?",1)[0].split("#",1)[0],t.startsWith("http")||1!==r&&!/^(?!http|s?ftp)[a-z\-]+:\/?\/?newtab\b\/?/i.test(t)?t:s.r.newTabUrl))}},n.D.vimSync.C=function(){if(!this.O&&true===this.z()){let e=n.D,t=0;for(let r in e)e[r].O||++t;let r=t>1;if(setTimeout(alert,100,i(r?"changedBeforeSync":"warningForSync")),r)return false}return true},n.D.keyboard.P={n:0,T:e=>null==e||e.length<2||!(e[0]>0&&e[0]<4e3)||!(e[1]>0&&e[1]<1e3)?s.r.keyboard:[+e[0],+e[1]].concat(e.slice(2))};