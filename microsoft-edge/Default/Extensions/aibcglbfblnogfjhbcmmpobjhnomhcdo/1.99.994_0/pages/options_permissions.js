import{$ as e,OnEdge as o,browser_ as t,OnFirefox as r,OnChrome as s,nextTick_ as i,CurCVer_ as n,IsEdg_ as l,post_ as m,pageLangs_ as a,prevent_ as p}from"./async_bg.js";import{Option_ as c,oTrans_ as f,bgSettings_ as u,delayBinding_ as d}from"./options_base.js";import{registerClass_ as _,createNewOption_ as h,TextOption_ as g}from"./options_defs.js";let w=t.permissions,v=e=>{if(!w)return function(){return m(25,{module:"permissions",name:e,args:[].slice.call(arguments)})};let o=w[e];return function(){let e=[].slice.call(arguments);return new Promise(r=>{e.push(e=>{let o=t.runtime.lastError;return r(o?[void 0,o]:[e,void 0]),o}),o.apply(w,e)})}},P={contains:v("contains"),request:v("request"),remove:v("remove")},O=null,b="downloads.shelf",U="chrome://new-tab-page/*",x="chrome://*/*",y={"clipboard-read":"opt_clipboardRead",[x]:"opt_chromeUrl",[U]:"opt_cNewtab",[b]:"opt_closeShelf"},B=e("#optionalPermissionsTemplate"),C=B.content.firstElementChild,j=B.parentElement,q=null,F=null,N=[];export const manifest_=t.runtime.getManifest();let S=manifest_.optional_permissions||[],k=[];export class OptionalPermissionsOption_ extends c{R(){d(this.x,"change",this.v)}z(){return N.map(e=>e.x.indeterminate?"1":e.x.checked?"2":"0").join("")}E(){return N.map(e=>e.S).join("")}N(e){for(let o=0;o<N.length;o++){let t=N[o];t.x.checked="2"===e[o],t.x.indeterminate="1"===e[o]}}J(e){let o=[],t=[],r={},s=1;for(let i=0;i<N.length;i++){let n=N[i],l=+e[i];if(n.S===l)continue;let a=n.me===U?"chrome://newtab/*":"";n.S=l,n.me===x&&u.h("allBrowserUrls")!==(2===l)&&(s++,Promise.resolve(u.h("allBrowserUrls")).then(e=>{e!==(2===l)?u.p("allBrowserUrls",2===l).then(m):m()})),2===n.ae||(l?(n.me===b&&o.push("downloads"),(1===n.ae?t:o).push(n.me),a&&t.push(a),r[n.me]=n):(s++,P.remove(1===n.ae?{origins:a?[n.me,a]:[n.me]}:{permissions:n.me===b?["downloads",n.me]:[n.me]}).then(([e,o])=>{let t="Can not remove the permission %o : ",r=o&&o.message||o;(o||!e)&&console.log(t,n.me,r);let s=n.x.parentElement;g.ne(o?t.replace("%o",n.me)+r:"",void 0,s),m()})))}let n=(e,[o,t])=>{if((t||!o)&&console.log("Can not request permissions of %o :",e,t&&t.message||t),!o){for(let o of e){let e=r[o];if(!e)continue;e.S=0;let s=e.x.parentElement;if(!t)return g.ne("",void 0,s);let n=(t&&t.message||JSON.stringify(t))+"";o.startsWith("chrome://")&&n.includes("Only permissions specified in the manifest")&&o.startsWith("chrome:")&&(n=f("optNeedChromeUrlFirst"),n=l?n.replace("chrome","edge"):n),n=f("exc")+n,g.ne(n,void 0,s),i(()=>{s.title=n})}this.w()}m()},m=()=>{s--,s>0||Promise.all(N.map(J)).then(()=>{this.w()})};if(s+=(o.length&&1)+(t.length&&1),o.length&&P.request({permissions:o}).then(n.bind(0,o)),t.length&&P.request({origins:t}).then(n.bind(0,t)),[].includes("clipboard-read")){let e=navigator.clipboard;s++,e.readText().catch(()=>{}).then(m)}return m(),Promise.resolve(e)}}_("OptionalPermissions",OptionalPermissionsOption_);let E=()=>{let e=document.createDocumentFragment();for(let o of N){let t=o.me,r=document.importNode(C,true),s=r.querySelector("input"),i=f(y[t]||`opt_${t}`)||t,n="";t.startsWith("chrome:")&&(i=l?i.replace("chrome:","edge:"):i,n=f("optOfChromeUrl").replace(l?"chrome":"edge","edge")),s.name=t,r.lastElementChild.textContent=i+n,(1===S.length||2===S.length&&"en"===a)&&r.classList.add("single"),e.append(r),o.x=s}j.append(e),d(j,"input",R,true),F&&d(F,"click",T,true)},J=e=>{let{ae:o,me:t}=e;return(2===o?Promise.resolve([1,void 0]):P.contains(1===o?{origins:[t]}:{permissions:t===b?["downloads",t]:[t]})).then(([o])=>{let r=o?2===e.ae?o:t!==x||u.h("allBrowserUrls")?2:1:0;e.S=r})},R=e=>{let o=e.target,t=N.find(e=>e.x===o);if(!t)return;let r=o.checked;if(t.me===x||t.me===U){let e=t.me===U,s=e?x:U,i=N.find(e=>e.me===s);i&&(e&&r&&!i.x.checked?(i.x.checked=false,i.x.indeterminate=true):!e&&r&&o.indeterminate?o.indeterminate=false:(i.x.checked=r,i.x.indeterminate=false))}},T=e=>{p(e),m(15,{u:e.target.href,p:false})};{let e=["downloads"];l&&e.push(U),e.push("cookies"),S=S.filter(o=>!e.some(e=>"string"==typeof e?o===e:e.test(o)))}if(S.length||0){for(let e of S)N.push({me:e,ae:e.includes(":")?1:0,S:0,x:null});i(E,9),Promise.all(N.map(J)).then(()=>{i(()=>{j.dataset.model="OptionalPermissions",h(j).w()})})}else i(()=>{e("#optionalPermissionsBox").style.display="none"},9);