import{a as Ce}from"../chunks/chunk-ED2QSM3M.js";import{a as ve,b as ye}from"../chunks/chunk-LWZ5KU7R.js";import{a as X}from"../chunks/chunk-D4YU7I4W.js";import{d as de,e as he,h as we}from"../chunks/chunk-ABHQJPMG.js";import"../chunks/chunk-3H7UDER3.js";import{a as _e}from"../chunks/chunk-SBTRYJIA.js";import{a as Te}from"../chunks/chunk-RQD6OPCK.js";import"../chunks/chunk-J6ZEYYTG.js";import{$ as le,D as ae,F as ne,V as se,W as re,X as ce,Y as pe,_ as ue,d as Z,f as ee,j as O,l as F,n as te,na as me,o as oe,va as ge,xa as fe}from"../chunks/chunk-XRJW3LFT.js";import"../chunks/chunk-5LUD7HVS.js";import"../chunks/chunk-K3HP5COO.js";import{a as M}from"../chunks/chunk-ZL5H3TML.js";import"../chunks/chunk-523WHQDT.js";import{a as Se}from"../chunks/chunk-MV4HDL2S.js";import"../chunks/chunk-6OCQJS5B.js";import{a as G}from"../chunks/chunk-2MCFUH3Z.js";import"../chunks/chunk-EHJWBWMG.js";import"../chunks/chunk-BWSZUVAY.js";import{a as ie}from"../chunks/chunk-5Q7VJYCY.js";import"../chunks/chunk-SSIZTBZJ.js";import{a as j,b as Ge}from"../chunks/chunk-X7CFCWZC.js";import"../chunks/chunk-P4L2RRIA.js";import"../chunks/chunk-G2MGIWVK.js";import"../chunks/chunk-XEDCPNRR.js";import"../chunks/chunk-BCG2KUGW.js";import"../chunks/chunk-YZTZIJSB.js";import"../chunks/chunk-YU5QULAP.js";import"../chunks/chunk-DGHEKRNY.js";import"../chunks/chunk-VGIBV4EV.js";import"../chunks/chunk-IYAFYZRF.js";import"../chunks/chunk-F2BE3OL5.js";import"../chunks/chunk-65VGUSSD.js";import{b as Q}from"../chunks/chunk-O7OTS7RM.js";import"../chunks/chunk-2SFZECRB.js";import"../chunks/chunk-D2CCZ3BJ.js";import{a as T}from"../chunks/chunk-7YV4JAJK.js";import"../chunks/chunk-KZL57NC7.js";import{s as W,v as z}from"../chunks/chunk-R5NGUZ66.js";import"../chunks/chunk-O4TFJKJQ.js";import{c as o,e as b,k,l as x,m as _,q as Y,u as w}from"../chunks/chunk-JJTF2C25.js";import"../chunks/chunk-6LTHT6DZ.js";import"../chunks/chunk-NYTRMFGH.js";import"../chunks/chunk-HY2GWXPO.js";import"../chunks/chunk-JV3JVBWM.js";import{O as K,P as Je,a as B,c as We,f as $,m as H,q as ze}from"../chunks/chunk-3HBOA5LN.js";import"../chunks/chunk-4NTWQHWX.js";import"../chunks/chunk-YHJJDH4X.js";import{e as E}from"../chunks/chunk-3GYLW4KZ.js";var Re=()=>Y("hasDeferredCouponRewards");var Ae=E(We());var t=E(B());var De=E(B());function J(){if(localStorage.getItem("__wb_redirecting")&&window.location.hostname.match(/secure|www\.nordstrom\.com/)&&window.location.pathname.match(/checkout\/sign-in/)){let i=!1,n=setInterval(()=>{let c=De.default.find(document.querySelectorAll("div button"),a=>a.textContent.match(/guest checkout/i));c&&!i&&(i=!0,c.click())},2e3);setTimeout(()=>{clearInterval(n)},1e4)}}Je();Ge();ze();window.__wb_timing.couponsRequireAt=performance.now();var Ue=new Set(["etsy.com","amazon.com"]),I=!1,L=!1,qe=t.default.throttle(X,2e3),Be=()=>{setTimeout(()=>{let i={currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])},n=t.default.extend({},window.__wb_timing,i);w("track","pageTimingMetrics",n)},5e3)};function $e(){return Ae.default.all([Se(),G(),ne(),_e(),Re(),ve()]).spread((i,n,c,a,r,u)=>{Te(i),o.merge({siteAPIData:n}),o.merge({cashback:c}),o.set("lifetimeSavings",a),o.set(["couponView","hasDeferredCouponRewards"],r),o.set("sameTabSuppressedDomains",u)})}var He=[{domain:"etsy.com"},{domain:"amazon.com",condition:i=>{let n=t.default.get(i,"pageType")==="checkoutPage",c=t.default.get(i,"pageData.meta"),a=c?c.coupon_input_present:!1;return n&&a}}];function be(i,n){return!!t.default.find(He,a=>a.domain===i&&(a.condition?a.condition(n):!0))}async function ke(){if(await $e(),await re("24_hr_throttle_all"))return;let n=k();Be();let c=["macys.com","jcpenney.com","kohls.com","walgreens.com","groupon.com","loft.com","fanatics.com","samsung.com","ulta.com","overstock.com","wish.com"];if(_("ext_inc_v_2")&&c.includes(n))return;if(navigator.userAgent.indexOf("Firefox")>-1&&n.match(/eyebuydirect\.com/))return!1;let a=o.get("cashback"),r=await O("affiliateRedirect");if(r){let s=JSON.parse(r);if(o.set("affiliateRedirect",s),await F("affiliateRedirect"),te()){let e=window.location.href,m=o.get("pageViewId");ye({resolvedUrl:e,domain:n,pageViewId:m})}}o.set("couponsVisible",!1);let u=o.get("siteAPIData"),p=await Ke(u),V=t.default.get(u,"siteData.coupons.tld")==="ebay.com"&&t.default.get(u,"siteData.coupons.coupons.length");oe()||(a&&!a.postCoupons&&!V?b({active:!0,cashback:a,fromCoupons:!0}):b({active:!0}));let g;try{g=JSON.parse(sessionStorage.getItem("ogPageData")),g&&g.expires<j()&&(sessionStorage.removeItem("ogPageData"),g=null)}catch{}async function y(s){if(qe(n,s),je(s),s.callSource==="internal"&&s.pageData)try{let e=JSON.parse(sessionStorage.getItem("cartTotalAfterSavings"));if(sessionStorage.removeItem("cartTotalAfterSavings"),!Number.isNaN(e.value)){let m=Date.now()-e.time;s.pageData?.order?.total>e.value&&m<2e3&&w("track","extensionError",{type:"coupon_error"})}}catch{}if(s.callSource==="coupons_start"&&s.pageData)sessionStorage.setItem("ogPageData",JSON.stringify({...s.pageData,expires:H($(new Date,3))}));else if(s.callSource==="coupons_end"){let e=o.select("couponView").get("resultTemp");e||(e=o.select("couponView").get("result"),e.pageReload=void 0);try{g=JSON.parse(sessionStorage.getItem("ogPageData"))}catch{}sessionStorage.removeItem("ogPageData");let m=t.default.get(g,"order.total");if(e.originalTotal=m||e.originalTotal,e.savings>0){t.default.get(s,"pageData.products.length")>1?s.pageData.products=t.default.map(s.pageData.products,(h,P)=>(t.default.has(h,"list_price")&&t.default.has(g,`products[${P}].list_price`)&&g.products[P].list_price-h.list_price&&(h.coupon_savings=g.products[P].list_price-h.list_price),h.coupon_applied=e.bestCoupon.code,h)):t.default.get(s,"pageData.products.length")===1&&(s.pageData.products[0].coupon_savings=e.savings,s.pageData.products[0].coupon_applied=e.bestCoupon.code);let D=s.pageData?.order?.total;D>0&&sessionStorage.setItem("cartTotalAfterSavings",JSON.stringify({value:D,time:Date.now()}))}let S=k(),d=o.get("couponsConfig");if(d&&d.pageWasReloaded){d.result=e;let D=o.get("couponView"),h=t.default.get(D,"resultTemp.allCoupons",[]);Ue.has(S)&&h.length>0&&(d.coupons=t.default.cloneDeep(h)),A(d,a)}else o.select("couponView").set("result",e);e&&e.couponScriptType==="roo"&&w("track","rooActionTiming",{triggerType:e.automaticCouponsRun?"auto":e.autoFallback?"auto_fallback":e.isSiteHub?"site_hub":null,couponRunId:e.couponRunId,aggApplyCodeTime:e.aggApplyCodeTime,aggGetTotalTime:e.aggGetTotalTime,aggRemovePreviousTime:e.aggRemovePreviousTime,aggWaitForReloadTime:e.aggWaitForReloadTime,initialActionTime:e.initialActionTime,currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])});let{cleanedSavings:Ve,wasCleaned:Ne}=Ye(e.savings),{automaticCouponsRun:xe,autoFallback:Oe,isSiteHub:Fe,manuallyActivatedAutoRun:Le,manuallyActivatedFallback:Pe}=e,Ee=me({automaticCouponsRun:xe||Le,autoFallback:Oe,isSiteHub:Fe,manuallyActivatedFallback:Pe});o.select("couponView").set("manuallyActivatedAutoRun",e.manuallyActivatedAutoRun);let Me=localStorage.getItem("__wb_redirecting")&&e.manuallyActivatedAutoRun,q=o.get("affiliateRedirect");e.manuallyActivatedAutoRun&&q&&(e.couponRunId=t.default.get(q,"couponRunId",e.couponRunId)),Me||(w("track","tryCouponsResult",{triggerType:Ee,couponScriptType:e.couponScriptType,clickId:e.clickId,redirectId:K(e.clickId),couponRunId:e.couponRunId,cashback:e.cashback,originalTotal:e.originalTotal,baseTotal:e.baseTotal,savingsOld:e.savings||0,savings:Ve,savingsWasCleaned:Ne,couponReloadSkipped:e.couponReloadSkipped,errored:e.errored,runTime:e.runTime,runTimeV2:new Date().getTime()-t.default.get(e,"startTime")||null,totalCouponsTested:t.default.get(e,"coupons.length"),coupons:t.default.get(e,"coupons"),originalCoupons:e.originalCoupons,preappliedCodes:e.preappliedCodes,bestCoupon:t.default.get(e,"bestCoupon.code"),platform:e.platform,currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])}),w("track","deweyResult",t.default.assign(s,{url:window.location.href})))}else if(g&&t.default.get(s,"pageType")&&!L)L=!0,p();else if(be(n,s)&&!I){if(t.default.get(s,"pageData"))if(n==="amazon.com")await Ie(s,p,a);else{let e=await p();if(e){I=!0;let m=await T({message:"getClassifierCodes",domain:n,pageData:s.pageData});if(m){let S=R({siteAPIData:u,classifierCoupons:m,rankedCoupons:e.coupons});e.coupons=S}A(e,a)}}}else if(!o.get("cashbackVisible")&&!t.default.get(a,"postCoupons")){let e=le()?3e3:1e3;setTimeout(()=>{if(!o.get("couponsVisible")){let m=o.get("deweyResult"),S=o.get("cashbackView");o.set("cashbackView",S),ce(m)}},e)}}let v=await O("rooReloading"),f=o.get("deweyResult");f&&!v&&y(f),v&&await F("rooReloading"),ie.emitter.on("result",y);function R({siteAPIData:s,classifierCoupons:e,rankedCoupons:m}={}){let S=t.default.get(s,"siteData.coupons.count"),d=t.default.concat(e,m);return d=t.default.uniqBy(d,"code"),d.slice(0,S)}J();let N=be(n,f),C;!N&&!L&&(L=!0,C=await p());let l=t.default.get(f,"pageData");if(N){if(n==="amazon.com")await Ie(f,p,a);else if(l&&!I){let s=await p();if(s){I=!0;let e=await T({message:"getClassifierCodes",domain:n,pageData:l});e&&(s.coupons=e),A(s,a)}}}C&&(C.pageWasReloaded||A(C,a))}async function A(i,n){let c="/coupons",{standDown:a}=i,r=k();o.merge("couponView",i);let u=o.get("cashbackView")||n;o.set("cashbackView",u);let p=o.get("hasActivatedCompetitor")||o.get("warnAboutStandDown"),V={initialRoute:c,cssUrl:"coupons.css",routeConfig:{childRoutes:[{path:"coupons",component:W(we)},{path:"reactivate",component:W(se)}]},disableDelay:!0};if(u&&t.default.get(u,"user.compInactivated")&&p&&!o.get("cashbackReactivateVisible")&&!o.get("throttleCreditsReactivation")){o.set(["warnAboutStandDown"],!0),o.set("cashbackReactivateVisible",!0),c="/reactivate",z({...V,initialRoute:c});return}let y=o.get("affiliateRedirect");if(sessionStorage.getItem("__wb_same_tab_auto")||sessionStorage.getItem("__r_reload_auto")){let l;if(y&&({manuallyActivatedAutoRun:l}=y,l&&o.select("couponView").set("manuallyActivatedAutoRun",l)),sessionStorage.getItem("__wb_same_tab_auto")){let s=JSON.parse(sessionStorage.getItem("__wb_same_tab_auto"));l=t.default.get(s,"manuallyActivatedAutoRun")}if(sessionStorage.getItem("__r_reload_auto")){let s=JSON.parse(sessionStorage.getItem("__r_reload_auto"));l=t.default.get(s,"manuallyActivatedAutoRun")}l||await T({domain:r,message:"endThrottle"})}try{let l=await O("deferredPinTab");l&&(ae(JSON.parse(l)),F("deferredPinTab"))}catch{}let v=ue(),f=r;Z(r)&&o.get("deweyResult","pageType")==="checkoutPage"&&(f="amazon.com_checkout");let R=await T({domain:f,message:"isThrottled",isAutoCoup:v});if(v&&await T({domain:f,message:"isAutoCoupThrottled",isAutoCoup:v})){if(o.get("affiliateRedirect")){let s=sessionStorage.getItem("__wb_clickId"),e=localStorage.getItem("__wb_redirecting");if(s&&!e){R||(sessionStorage.removeItem("__wb_clickId"),pe());return}}o.select("couponView").set("autoCoupThrottled",!0)}let N=!!o.get(["events","hasSeenCouponsThrottleToolTip"]),C=R&&!N&&!i.pageWasReloaded;if(o.select("couponView").set("showThrottleToolTip",C),R&&!i.pageWasReloaded){if(o.set("couponsThrottled",!0),!C){b({active:!0,textOverride:`${t.default.get(i,"coupons.length","")}C`});return}}else if(a){o.set("couponsThrottled",!0);return}o.get(["couponView","standDownOverride"])&&b({active:!0,textOverride:`${t.default.get(i,"coupons.length","")}C`}),r==="groupon.com"&&w("track","foundCouponsEnd",{pageViewId:o.get("pageViewId")}),o.get("couponsVisible")||(o.set("couponsVisible",!0),z(V))}function U(i,n){w("track","platformIdentified",{platform:n,currentLocation:t.default.pick(window.location,["hash","host","hostname","href","origin","pathname","port","search"])})}function je(i){let n=k(),c=_("ext_separate_domain_platform")?o.get("platformDomain"):M(n);if((_("ext_separate_domain_platform")?o.get("platform")==="Shopify":c)&&i&&i.pageType==="checkoutPage"){let r=document.querySelectorAll(".notice.notice--warning .notice__text"),u=t.default.find(r,p=>p.offsetHeight>0);if(u){let p=u.querySelector("strong").innerText.trim();w("track","shopifyInvalidCouponDetected",{domain:n,coupon:p})}}}async function Ke(i){let n=t.default.get(i,"tld"),c=await Ce();c&&(o.set(["platform"],c),U(n,c)),x(n);let a=_("ext_separate_domain_platform")?o.get("platformDomain"):M(n),r=_("ext_separate_domain_platform")?o.get("platform")==="Shopify":a;if(a&&(_("ext_separate_domain_platform")?U(n,o.get("platform")):U(n,"Shopify")),t.default.get(i,"siteData.coupons.ignoreSite"))return t.default.noop;if(t.default.get(i,"siteData.coupons.type")==="eeyore"&&t.default.get(i,"siteData.coupons.coupons.length")>0)return t.default.get(i,"siteData.coupons.identifiers")?fe:t.default.noop;if(t.default.get(i,"siteData.coupons.type")==="tigger"&&(a||ee(n,c))){if(a){if(x(a),a!==n){let u=await T({message:"makeRequest",reqInfo:{method:"GET",url:`${Q}/site/${a}`,headers:{"Content-Type":"application/json"}}}),p=t.default.get(u,"siteData.coupons");t.default.assign(i,{tld:p.tld}),x(p.tld),t.default.assign(i.siteData.coupons,{coupons:p.items||[],ignoreSite:t.default.isUndefined(p.ignoreSite)?!0:p.ignoreSite,ignoreAffiliate:t.default.isUndefined(p.ignoreAffiliate)?!0:p.ignoreAffiliate,tld:p.tld})}r&&(i.siteData.coupons.shopify=!0,i.siteData.appliedCodeSelector=".applied-reduction-code__information"),await G(t.default.assign(i,{domain:a,setSite:!0}))}return ge}else{if(t.default.get(i,"siteData.coupons.type")==="roo")return de;if(t.default.get(i,"siteData.coupons.type")==="asyncTigger")return t.default.get(i,"siteData.coupons.identifiers")?he:t.default.noop}return t.default.noop}async function Ie(i,n,c){if(i){let a=await n({experience:"checkout"});if(!_("amz_class_on"))return;I=!0;let r=await T({message:"getClassifierCodes",domain:"amazon.com",pageData:i.pageData,pageViewId:o.get("pageViewId")});r&&(a.coupons=r),r&&r.length>=1&&(a.couponCount=r.length,A(a,c))}}function Ye(i){let a=!1,r=i||0;return r=parseInt(r),isNaN(r)&&(a=!0,r=0),r>1e8?(a=!0,r=1e8):r<-1e8&&(a=!0,r=-1e8),{cleanedSavings:r,wasCleaned:a}}document.readyState!=="loading"?ke():document.addEventListener("DOMContentLoaded",ke);export{ke as init};
