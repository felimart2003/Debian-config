import{OnFirefox as e,OnEdge as t,OnChrome as l,$ as n,pageTrans_ as o,enableNextTick_ as s,nextTick_ as i,IsEdg_ as u,post_ as r,toggleReduceMotion_ as a,hasShift_ as c,PageOs_ as p,setupPageOs_ as f,prevent_ as h,CurCVer_ as d}from"./async_bg.js";import{bgSettings_ as m,ExclusionRulesOption_ as g,setupBorderWidth_ as w,showI18n_ as _,setupSettingsCache_ as b}from"./options_base.js";let v,R,y,k,O="",x=0,P=true,j=null,L=null,T=0,E=/^[a-z][\+\-\.\da-z]+:\/\//,$=n("#state-action"),S=n("#saveOptions"),U=$.nextElementSibling,D=U.nextElementSibling,N=Object.create(null),z=(e,t)=>o(e,t)||"";class A extends g{G(e,t){super.G(A.ue(),t)}et(e){return e.st=e.it.pattern&&N[e.it.pattern]||false,B(e.st)}N(e){super.N(e),this.N=null,A.prototype.et=g.prototype.et;let t,l=this.q.filter(e=>e.nt),n=l.length>0;x=n?2:1,n?(t=l[0].lt,H(true)):(this.G("",false),t=this.q[this.q.length-1].lt),setTimeout(()=>{t.focus()},67)}J(e){let t=super.J(e),l=M(`${v.tabId}/reset/silent`);return Promise.all([t,l]).then(([e])=>e)}ot(e,t,l){let n=e.it.pattern===t,o=e.st;super.ot(e,t,l);let s=t?l?l.length>1&&"^"===l[0]?z("onlyHook")||"only hook such keys":z("passThrough")||"pass through such keys":z("completelyDisabled")||"completely disabled":"";e.tt.title!==t&&(e.tt.title=t),e.lt.title!==s&&(e.lt.title=s),n?e.st=o:this.ce(e,t)}ce(e,t){let l,n=e.tt;e.U&=-5,t&&t!==A.ue()?(l=F(e))instanceof Promise?l.then(()=>{this.ce(e,t)}):B(l)?n.title=n.style.color="":(e.U|=4,n.style.color="red",n.title="Red text means that the pattern does not\nmatch the current URL."):n.title=n.style.color=""}static ue(){let e=R.split(/[?#]/)[0],t=e.startsWith("http:")?"^https?://"+e.split("/",3)[2].replace(/[$()*+.?\[\\\]\^{|}]/g,"\\$&")+"/":e.startsWith(location.origin+"/")?":vimium:/"+new URL(e).pathname.replace("/pages",""):/^[^:]+:\/\/./.test(e)&&!e.startsWith("file:")?":"+e.split("/",3).join("/")+"/":":"+e;return N[t]||(N[t]=G("^"===t[0]?{t:1,v:t}:{t:2,v:t.startsWith(":vimium:")?e:t.slice(1)})),A.ue=()=>t,t}}let H=e=>{L.z(true);let t=L.q.filter(e=>e.nt&&(!!e.it.pattern||!!(4&e.U))),l=x;x=2,Promise.all(t.map(e=>null!==e.st?e.st:F(e))).then(()=>{V(l,e,t)})},V=(e,t,l)=>{let n=3===e,o=K(!!O,l);o&&(o=I(o)),t&&(j=e>=2?o:null);let s=o===j,i=!!o&&o.length>2&&"^"===o[0];$.textContent=(n?o?z("137")+z(i?"138":"139"):z("140"):z(s?"141":"142")+z(o?i?"138":"139":s?"143":"143_2")).replace(" to be","")+z("colon")+z("NS"),U.className=o?"code":"",U.textContent=o?i?o.slice(2):o:z("143_3")+z(null!==o?"144":"145"),D.textContent=null!==v.lock&&!n&&s?z("147",[z(0!==v.lock?"144":"145")]):null!==v.lock?z("148"):"";let u=l.some(e=>!!(4&e.U)&&(e.it.pattern!==e.Y.pattern||e.it.passKeys!==e.Y.passKeys));S.disabled=s&&!u,S.firstChild.data=z(n?"115_3":s&&!u?"115":"115_2")},C=()=>{if(!S.disabled)return s(8),L.K().then(()=>{s(0,8),x=3,Q(),H(true),S.firstChild.data=z("115_3"),S.disabled=true,P=true})},I=e=>{let t=(e=e.trim()).length>2&&e.startsWith("^");t&&(e=e.slice(1).trimLeft());let l=Object.create(null);for(let t of e.split(" "))l[t]=1;return(t?"^ ":"")+Object.keys(l).sort().join(" ")},M=e=>r(22,[e,v.tabId,v.frameId]).then(e=>{v.status=e[0],v.lock=e[1]}),q=(e,t)=>{t&&h(t);let l=t&&(t.ctrlKey||t.metaKey);M(`${v.tabId}/${e}`).then(()=>{l?(Q(),H(false)):window.close()})},B=e=>!!e&&(2===e.t?R.startsWith(e.v)||!!O&&O.startsWith(e.v):3===e.t?e.v.p.test(R)||!!O&&e.v.p.test(O):e.v.test(R)||!!O&&e.v.test(O)),F=e=>{let t=e.it.pattern,l=N[t];if(l)return e.st=l instanceof Promise?l.then(t=>e.st=t):l;let n=r(23,t);return N[t]=e.st=n.then(l=>N[t]=e.st=G(l))},G=e=>2===e.t?{t:e.t,v:e.v}:3===e.t?{t:e.t,v:{p:d<107?new URLPattern(e.v):new URLPattern(e.v,"http://localhost",{ignoreCase:true}),s:e.v}}:{t:e.t,v:new RegExp(e.v,"")},J=()=>{let{rules:e,matchers:t}=v.exclusions;for(let l=0,n=e.length;l<n;l++){let n=e[l].pattern;N["__proto__"!==n?n:"_"]=G(t[l])}},K=(e,t)=>{let l="";for(let e of t){let t=e.st;if(t&&(2===t.t?R.startsWith(t.v):3===t.t?t.v.p.test(R):t.v.test(R))){let t=e.it.passKeys;if(0===t.length||k||"^"===t[0]&&t.length>2)return t;l+=t}}return!l&&e&&R.lastIndexOf("://",5)<0&&!E.test(R)&&O?K(false,t):l||null},Q=()=>{y=2!==v.status?"Disable":"Enable";let e=n("#toggleOnce"),t=e.nextElementSibling;i(()=>{e.firstElementChild.textContent=(z(y)||y)+(null!==v.lock?"":z("Once")),e.onclick=q.bind(null,y),U.id="state-value",t.classList.toggle("hidden",null===v.lock),null!==v.lock&&(t.firstElementChild.onclick=q.bind(null,"Reset"))})},W=e=>{let t=n(".options-link"),l=location.origin+"/pages/options.html";e.startsWith(l)?i(()=>{t.nextElementSibling.remove(),t.remove()}):(t.href!==l&&i(()=>{t.href=l}),t.onclick=e=>{h(e),r(15,{u:l,p:true}).then(()=>{window.close()})})},X=()=>{p||window.addEventListener("keydown",e=>{13===e.keyCode&&e.metaKey?Y(e):e.altKey&&(88===e.keyCode||null!==v.lock&&90===e.keyCode)&&!(e.ctrlKey||e.metaKey||c(e))&&(h(e),e.stopImmediatePropagation(),q(88===e.keyCode?y:"Reset"))}),L=new A(n("#exclusionRules"),()=>{if(P){P=false;let e=!T&&n("#helpSpan");e&&(e.nextElementSibling.style.display="",e.remove(),T=1)}H(x<2)}),L.w()};r(20).then(e=>{v=e,f(v.os);let t=v.url,l=n("#blocked-msg");if(s(1),!v.runnable)return ee(l),W(t),i(_),void i(Z);i(e=>{l.remove(),l=null,a(v.reduceMotion),e.textContent=v.ver},n("#version")),O=v.topUrl||t,R=v.frameUrl||O,k=v.exclusions.onlyFirst,m.r={exclusionRules:v.exclusions.defaults},b({exclusionRules:v.exclusions.rules}),J(),v.exclusions=null,S.onclick=C,document.addEventListener("keyup",Y),W(t),Q(),X(),i(_),w&&i(w),i(Z)});let Y=e=>{if(13===e.keyCode){let t=e.target;if(t instanceof HTMLAnchorElement)t.hasAttribute("href")||setTimeout(e=>{e.click(),e.blur()},0,t);else if(e.ctrlKey||e.metaKey){let e=!P&&C();e&&e.then(()=>{setTimeout(window.close,300)})}}},Z=()=>{let e=document.documentElement;e.classList.remove("loading"),e.style.width="",e.style.height=""},ee=e=>{let t=v.url||"",l=document.body;l.innerText="",e.style.display="",e.querySelector("#version").textContent=v.ver;let o,s,i=e.querySelector("#refresh-after-install");v.tabId<0||!t||!/^(ht|s?f)tp/i.test(t)?i.remove():!u&&(o=navigator.userAgentData,(s=o&&(o.brands||null))?s.find(e=>e.brand.includes("Opera")):/\b(Opera|OPR)\//.test(navigator.userAgent))&&/\.(google|bing|baidu)\./.test(t.split("/",4).slice(0,3).join("/"))&&(e.querySelector("#opera-warning").style.display=""),l.append(e);let a=v.unknownExt;if(a){let e=n("#injection-refused");e.style.display="",e.nextElementSibling.remove(),n("#doAllowExt").onclick=function(){this.onclick=null,r(21,[v.tabId,a]).then(()=>{setTimeout(()=>{location.reload()},0)})}}let c=n("#retryInject");c&&(/^(file|ftps?|https?):/.test(t)&&v.tabId>=0?c.onclick=e=>{h(e),r(6,v.tabId).then(()=>{window.close()})}:(c.nextElementSibling.remove(),c.remove()))};