(self.webpackChunk=self.webpackChunk||[]).push([[4382],{8366:(e,t,i)=>{i.r(t),i.d(t,{CheetahFeatureImpl:()=>Jt,isAssistantOpened:()=>$t,isGenAIAssistantOpened:()=>Xt});var s=i(17771),a=i(17889),r=i(62965),n=i(85892),o=i(57050),l=i(27378),c=i(54696),d=i(55649),u=i(14601),p=i(32952),h=i(60797),g=i(66310),m=i(24209),v=i(85985),_=i(23063),f=i(40151),b=i(98403),S=i(2844),y=i(77176),A=i(2834),w=i(76974),I=i(28043),C=i(93508),R=i(16118),x=i(13444),k=i(12126),P=i(78674),E=i(17343),U=i(5114),B=i(8125),O=i(83078),T=i(54001),M=i(23239),N=i(34217),D=i(51325);const F=({width:e,height:t,top:i,left:s,visibility:a})=>l.createElement("div",{"data-grammarly-part":"cheetah-highlight-rect",...(0,T.Sh)(D.highlightRect,"hidden"===a?D.hidden:null,"attention"===a?D.attention:null),style:{width:e,height:t,top:i,left:s}});var G=i(24426),z=i(88571),H=i(4147),q=i(89894),V=i(15073),W=i(42103),j=i(67127),L=i(90845),Q=i(85665),K=i(13713),Z=i(41944);const Y=q.ux.style({fontStyle:"normal",fontWeight:"normal",fontFamily:"Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif, Arial",$nest:{"button, input, textarea":{fontFamily:"inherit"}}}),$=({children:e})=>{var t;const i=null===(t=l.useContext(Q.nS.Context))||void 0===t?void 0:t.host;return l.createElement(H.o,null,l.createElement(z.Q,{remSize:w.of(16),setter:e=>V.u.setRootCssVar(i||document.documentElement,e)},l.createElement(W.G.DefaultProvider,null,l.createElement("div",{className:Y},e,l.createElement(j.X,null)))))},X=({children:e})=>{var t;const i=null===(t=l.useContext(Q.nS.Context))||void 0===t?void 0:t.host,{onMount:s,ref:a}=L.P.useElWatcher();return l.createElement(H.o,null,l.createElement(z.Q,{remSize:w.of(16),setter:e=>V.u.setRootCssVar(i||document.documentElement,e)},l.createElement(W.G.DefaultProvider,null,l.createElement("div",{className:Y,ref:s,"data-role":"onboarding-tooltips",style:{position:"absolute",zIndex:Z.dl+1}},l.createElement(K.l.Provider,{value:{portalContainer:a}},e),l.createElement(j.X,null)))))};var J=i(37869),ee=i(50783);const te=({referenceElement:e,placement:t,offset:i,disabled:s,onClick:a})=>{const[r,n]=l.useState(null),{styles:o,attributes:c}=(0,J.D)(e,r,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return l.createElement("button",{ref:n,style:o.popper,...c.popper,onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-reply-button",className:ee.replyButton,"data-disabled":s},l.createElement("div",{className:ee.icon}),l.createElement("span",null,"Reply quickly"))};var ie=i(6726),se=i(87491);const ae=({referenceElement:e,placement:t,offset:i,disabled:s,onMagicRewriteClick:a,onOpenRewriteClick:r})=>{const[n,o]=l.useState(null),{styles:c,attributes:d}=(0,J.D)(e,n,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return a||r?l.createElement("div",{ref:o,style:c.popper,...d.popper,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-entry-button",className:se.entryButton,"data-disabled":s},a?l.createElement(ie.u,{message:"Improve it"},l.createElement("button",{onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:se.entryButtonItem,"data-disabled":s},l.createElement("i",{className:se.rewriteIcon}))):null,r?l.createElement(ie.u,{message:"Rewrite with Grammarly"},l.createElement("button",{onClick:r,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:se.entryButtonItem,"data-disabled":s},l.createElement("i",{className:se.openIcon}))):null):null};var re=i(49708),ne=i(8543),oe=i(48033);const le=()=>l.createElement("svg",{className:oe.icon,viewBox:"0 0 16 16",fillRule:"evenodd",clipRule:"evenodd",strokeLinecap:"round"},l.createElement("path",{d:"M8,16C12.418,16 16,12.418 16,8C16,3.582 12.418,0 8,0C3.582,0 0,3.582 0,8C0,12.418 3.582,16 8,16Z",fill:"#0A9A78"}),l.createElement("path",{d:"M4,8L12,8M8,4L8,12",fill:"none",fillRule:"nonzero",stroke:"white",strokeWidth:"1.5px"})),ce=({overflow:e,...t})=>e?l.createElement(ue,{...t}):l.createElement(de,{...t}),de=({left:e,top:t,height:i})=>l.createElement(l.Fragment,null,l.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:oe.quasiCaret,style:{left:e,top:t+i,height:i+8}},l.createElement(le,null))),ue=({left:e,top:t,height:i})=>{const{ref:a,onMount:r}=L.P.useElWatcher(),n=l.useMemo((()=>M.h.create(U.none)),[]),{rect:c,onMount:d}=L.P.useRectWatcher(),u=l.useCallback((e=>{e.style.pointerEvents="all",n.set((0,o.zG)(s.Y(U.option)({rect:U.some(e.getBoundingClientRect()),goodParent:(0,o.zG)(e.getBoundingClientRect(),(e=>({x:e.x+e.width/2,y:e.y+e.height/2})),(({x:e,y:t})=>{var i,s;return U.fromNullable(null===(s=null===(i=document.elementFromPoint(e,t))||void 0===i?void 0:i.shadowRoot)||void 0===s?void 0:s.elementFromPoint(e,t))}),U.filter((t=>t===e||e.contains(t||null))))}),U.fold((()=>U.none),(({rect:e})=>U.some({x:e.x,y:e.y}))))),e.style.pointerEvents="none"}),[]),p=l.useMemo((()=>re.R(document,"scroll",{capture:!0}).pipe(C.O(null))),[]);return L.P.useSubscriptionTo(S.aj([a.pipe(h.oA),p,c]).pipe(A.b((([e])=>u(e))))),l.createElement(l.Fragment,null,l.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:oe.quasiCaret,style:{left:e,top:t+i,height:i+8},ref:e=>{r(e),d(e)}},l.createElement(ne.F.div,{style:n.pipe(y.U((e=>(0,o.zG)(e,U.fold((()=>({opacity:1})),(()=>({opacity:0})))))))},l.createElement(le,null))),l.createElement(ne.F.Fragment,null,n.pipe(y.U((e=>(0,o.zG)(e,U.fold(o.gn,(e=>l.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret-fixed-bro",className:oe.quasiCaret,style:{transform:"none",position:"fixed",left:e.x,top:e.y,height:i+8}},l.createElement(le,null))))))))))};var pe=i(10389),he=i(9205),ge=i(1846),me=i(819),ve=i(20545),_e=i(24451),fe=i(18884),be=i(55093),Se=i(21903);var ye=i(2146),Ae=i(65504),we=i(64015),Ie=i(88355),Ce=i(4068),Re=i(22232),xe=i(30857);function ke(e){var t;return"genAI"!==e.assistantMode&&"genAIAndWritingExpert"!==e.assistantMode&&"inlineCardSource"===e.source.kind&&null!==(t=e.source.alertId)&&void 0!==t?t:null}function Pe(e,t,i,s){switch(e.genAISessionMode){case"ideation":return{mode:e.genAISessionMode,metadata:t,documentUrl:s};case"rewrite":case"quickRewrite":return{mode:e.genAISessionMode,metadata:t};case"quickReply":return{mode:e.genAISessionMode,quickReplyContext:(0,o.zG)(i,U.fold((()=>Ce.H.empty),Ee)),metadata:t};case"pushRewrite":return{mode:e.genAISessionMode,writingExpertContext:e.writingExpertContext};default:(0,Re.L0)(e)}}function Ee(e){var t,i,s,a,r,n,l,c,d,u,p,h,g,m,v,_,f;const b=e=>{var t;return null!==(t=null==e?void 0:e.reduce(((e,t)=>{var i;return t.email&&!e.has(t.email)&&e.set(t.email,{name:null!==(i=t.name)&&void 0!==i?i:"",email:t.email}),e}),new Map))&&void 0!==t?t:new Map},S=b(null===(s=null===(i=null===(t=e.parents)||void 0===t?void 0:t[0])||void 0===i?void 0:i.audience)||void 0===s?void 0:s.indirectRecipients),y=b(null===(n=null===(r=null===(a=e.parents)||void 0===a?void 0:a[0])||void 0===r?void 0:r.audience)||void 0===n?void 0:n.undisclosedRecipients),A=b(null===(u=null===(d=null===(c=null===(l=e.parents)||void 0===l?void 0:l[0])||void 0===c?void 0:c.audience)||void 0===d?void 0:d.recipients)||void 0===u?void 0:u.filter((({email:e})=>(0,xe.HD)(e)&&!S.has(e)&&!y.has(e)))),w=b(null===(p=e.audience)||void 0===p?void 0:p.indirectRecipients),I=b(null===(h=e.audience)||void 0===h?void 0:h.undisclosedRecipients),C=b(null===(m=null===(g=e.audience)||void 0===g?void 0:g.recipients)||void 0===m?void 0:m.filter((({email:e})=>(0,xe.HD)(e)&&!w.has(e)&&!I.has(e))));return{previousMessageInfo:(0,o.zG)(we.YM(null!==(v=e.parents)&&void 0!==v?v:[]),U.fold((()=>Ce.H.PreviousMessageInfo.empty),(e=>{var t;return{author:(0,o.zG)(we.YM(null!==(t=e.authors)&&void 0!==t?t:[]),U.fold((()=>Ce.H.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(A.values()),text:e.delta?(0,Ie.l)(e.delta,""):""}}))),title:null!==(_=e.title)&&void 0!==_?_:"",author:(0,o.zG)(we.YM(null!==(f=e.authors)&&void 0!==f?f:[]),U.fold((()=>Ce.H.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(C.values()),indirectRecipients:Array.from(w.values()),undisclosedRecipients:Array.from(I.values())}}var Ue=i(13853),Be=i(19751),Oe=i(7604),Te=i(95300),Me=i(73975);class Ne{constructor(e){this._params=e,this._subs=new u.w,this._visibleAlerts=new Te.X(new Set),this._emphasizedAlerts=new Te.X(new Set),this.hasHighlights=this._visibleAlerts.pipe(y.U((e=>e.size>0)),C.O(!1),I.x(),Be.shareReplay({bufferSize:1,refCount:!0})),this.alertsFilter=this._visibleAlerts.pipe(Be.skipBy(Ue.Eh(Me.yv)),P.b(0),y.U((e=>t=>e.has(t.id))),Be.shareReplay({bufferSize:1,refCount:!0})),this._subs.add(this._visibleAlerts.subscribe((e=>{var t;return null===(t=this._params.logger)||void 0===t?void 0:t.debug("visible highlights",e)}))),this._subs.add(this._emphasizedAlerts.subscribe((e=>{var t;return null===(t=this._params.logger)||void 0===t?void 0:t.debug("emphasized highlights",e)})))}setAlertsVisibility(e){this.clearAll();const t=new Set(this._visibleAlerts.value),i=new Set(this._emphasizedAlerts.value);e.filter((e=>"hidden"!==e.visibility)).forEach((({alertId:e,visibility:s})=>{this._params.getAlertById(e)&&(t.add(e),"emphasized"===s&&i.add(e))})),this._visibleAlerts.next(t),this._emphasizedAlerts.next(i)}updateAlertsVisibility(e){const t=new Set(this._visibleAlerts.value),i=new Set(this._emphasizedAlerts.value);e.forEach((({alertId:e,visibility:s})=>{this._params.getAlertById(e)&&"hidden"!==s?(t.add(e),"emphasized"===s?i.add(e):i.delete(e)):(t.delete(e),i.delete(e))})),this._visibleAlerts.next(t),this._emphasizedAlerts.next(i)}clearAll(){this._visibleAlerts.next(new Set),this._emphasizedAlerts.next(new Set)}getHighlightVisualState(e){const t=this._params.alertStateService.getHighlightedAlert().pipe(y.U((t=>{var i;return!0===(null===(i=null==t?void 0:t.highlightIds)||void 0===i?void 0:i.includes(e))})),C.O(!1),I.x()),i=this._params.alertStateService.getActiveAlertByClick().pipe(y.U((t=>{var i;return!0===(null===(i=null==t?void 0:t.highlightIds)||void 0===i?void 0:i.includes(e))})),C.O(!1),I.x()),s=this._emphasizedAlerts.pipe(y.U((t=>Array.from(t).some((t=>this._params.aquaAlertsWiring.getHighlightsForAlert(t).includes(e))))),I.x());return S.aj([t,i,s]).pipe(y.U((([e,t,i])=>({hovered:e,selectedByClick:t,emphasized:i}))),C.O({hovered:!1,selectedByClick:!1,emphasized:!1}),R.G(),y.U((([e,t])=>t.hovered||t.selectedByClick?Oe.pc.hovered:t.emphasized?e.hovered||e.selectedByClick?Oe.pc.hovered:Oe.pc.hoveredNeedsAttention:Oe.pc.none)),C.O(Oe.pc.none),I.x(),A.b((t=>{var i;return null===(i=this._params.logger)||void 0===i?void 0:i.debug(`[${e}] visual state:`,t)})))}dispose(){this.clearAll(),this._subs.unsubscribe()}}class De{constructor(e){this._params=e}scrollAlertIntoView({alertId:e}){var t;const i=null===(t=this._params.getAlertById(e))||void 0===t?void 0:t.highlightRanges[0];i&&this._params.integration.scrollHighlightIntoView(i)}}var Fe=i(80358),Ge=i(95399),ze=i(18625),He=i(19125);var qe=i(34327),Ve=i(71078),We=i(36919),je=i(20236);var Le=i(71032),Qe=i(731),Ke=i(95195),Ze=i(9629),Ye=i(8709),$e=i(67534),Xe=i(42606);class Je extends Error{constructor(e,t){var i;super(`Failed to apply alert. Reason: ${null!==(i=null==t?void 0:t.toString())&&void 0!==i?i:"unknown"}. Alert ID: ${e.alertId}. Alternative index: ${e.alternativeIndex}. Feed form: ${e.feedForm}.`),this.name="ApplyAlertError"}}var et=i(5957),tt=i(16782);async function it(e,t,i,s,a,r,n){var l,d,u,p,h,g;const m=t(e.alertId);if(U.isNone(m))throw new Je(e,"alert-not-found");if(!je.S.isCapiAlert(m.value))throw new Je(e,"alert-not-supported");const v=function(e,t){if(c.$.isWithTransformJson(e)){const i=(0,o.zG)(e.transformJSON.alternatives,U.chain((e=>U.fromNullable(e.alternatives[t.alternativeIndex]))),U.map((e=>e.delta)),U.getOrElseW((()=>null)));if(null===i)throw new Je(t,"alternative-not-found");return i}if(c.$.isWithSubAlerts(e)){const i=(0,o.zG)(e.subalerts.alternatives,U.chain((e=>U.fromNullable(e.alternatives[t.alternativeIndex]))),U.map((e=>e.delta)),U.getOrElseW((()=>null)));if(null===i)throw new Je(t,"alternative-not-found");return i}if(c.$.isWithPosition(e))return(new Ye.i).retain(e.transformRange.start).delete(e.transformRange.end-e.transformRange.start).insert(e.transformText);(0,Re.L0)(e)}(m.value,e),f=(0,$e.g)(v),b=(0,$e.B)(v);let S;const y=new tt.t(1),A=a.contentChanges.immediate.pipe(P.b(0)).subscribe(y);try{S=await Promise.race([i.performBatchReplacements(f,{alert:m.value}),(0,et.gw)(null!==(u=null===(d=null===(l=r.get().oggy)||void 0===l?void 0:l.alertService)||void 0===d?void 0:d.applyAlertsPerformBatchReplacementsTimeoutMs)&&void 0!==u?u:1e3,new Je(e,"perform-batch-replacements-timeout")).then((()=>[]))])}catch(t){throw t instanceof Je?t:new Je(e,"perform-batch-replacements-critical-error")}const w=S.find(Xe.j.isFail);if(w&&Xe.j.isFail(w))throw new Je(e,w.reason);n.isGateEnabled(he.K.SharedAssistantApplyAlertsSequentialWaitForTextMapContentChanges)&&await Promise.race([y.pipe(_.q(1)).toPromise(),(0,et.gw)(null!==(g=null===(h=null===(p=r.get().oggy)||void 0===p?void 0:p.alertService)||void 0===h?void 0:h.applyAlertsWaitForTextMapContentChangesTimeoutMs)&&void 0!==g?g:1e3,new Je(e,"wait-for-text-map-content-changes-timeout"))]),A.unsubscribe();const I=s();if(U.isSome(I)&&b.length>0)for(const t of b)try{await I.value.apply(t.range,t.formatting)}catch(t){throw new Je(e,"apply-formatting-critical-error")}}var st=i(3236);class at{constructor(e){var t,i,s;this._params=e,this._subs=new u.w,this._logger=d.Y.create("AlertServiceImpl"),this._replacementStrategy=this._params.experimentClient.getTreatment(Ze.p.SharedAssistantMitigateApplyAlertsTextCorruption),this._replacementService=(t=this._params.replacementServiceInjector,"delayed"===(i=this._replacementStrategy)?t.create(st.P.oggyRevisionDelayed):"sequential"===i?t.create(st.P.oggyRevisionSequential):t.create(st.P.oggyRevision)),this._selectedAlertId=M.h.create(this._params.initialAlertId),this._applyAlertsRequests=new p.xQ,this._applyAlertsSequentiallyRequests=new p.xQ,this.selectedAlertId=this._selectedAlertId.view(),this.alertCollectionChanges=(s=this._params.alertProcessor.alerts,ze.P((()=>s.changes.pipe(y.U((e=>{const t=new Set(e.addedAlerts.filter(je.S.isCapiAlert).map((e=>e.id))),i=new Set(e.removedAlerts.filter((e=>je.S.isCapiAlert(e.alert))).map((e=>e.id)));return[...e.addedAlerts.filter(je.S.isCapiAlert).filter((e=>!i.has(e.id))).map((e=>(0,Ve.Tm)(e.id))),...e.removedAlerts.filter((e=>je.S.isCapiAlert(e.alert))).filter((e=>!t.has(e.id))).map((e=>(0,Ve.qQ)(e.id,"textChange"===e.reason._tag?"textChange":"other")))]})),C.O(Array.from(s.getAll()).filter(je.S.isCapiAlert).map((e=>(0,Ve.Tm)(e.id)))),(e=>e.pipe(We.f(e.pipe(P.b(0))))),y.U((e=>e.flatMap(o.yR))),v.h((e=>e.length>0)))))),this._subs.add(this._params.alertStateService.getActiveAlertByClick().pipe(y.U((e=>{var t;return null!==(t=null==e?void 0:e.alertId)&&void 0!==t?t:null}))).subscribe(b.wW(this._selectedAlertId))),this._subs.add(this._applyAlertsRequests.pipe(Le.b((e=>k.D(this._applyAlerts(e).catch((()=>{})))))).subscribe()),this._subs.add(this._applyAlertsSequentiallyRequests.pipe(Le.b((({applyAlertsInfo:e,deferredPromise:t})=>k.D(this._applyAlertsSequentially(e).then(t.resolve).catch(t.reject))))).subscribe())}async _applyAlerts(e){const t=(0,Qe.H)(e,(e=>U.fromNullable(this._params.alertProcessor.alerts.getAlertById(e))),this._replacementService,this._params.getFormattingService);this._params.requestAwaitService.addRequest(t);const i=await t;if(Ke.isLeft(i))throw this._logger.warn("Error applying alerts.",{applyAlertsInfo:e,error:i.left}),i.left}async _applyAlertsSequentially(e){try{this._logger.debug("Applying alerts sequentially.",{applyAlertsInfo:e}),await async function(e,t,i,s,a,r,n){for(const o of e)await it(o,t,i,s,a,r,n)}(e,(e=>U.fromNullable(this._params.alertProcessor.alerts.getAlertById(e))),this._replacementService,this._params.getFormattingService,this._params.textObserver,this._params.dynamicConfig,this._params.experimentClient)}catch(t){throw this._logger.warn("Error applying alerts sequentially.",{applyAlertsInfo:e,error:t}),t}}applyAlerts(e){var t,i,s;if(this._logger.debug("Received apply alerts request.",{applyAlertsInfo:e}),"delayed"===this._replacementStrategy)return setTimeout((()=>this._applyAlertsRequests.next(e)),null!==(s=null===(i=null===(t=this._params.dynamicConfig.get().oggy)||void 0===t?void 0:t.alertService)||void 0===i?void 0:i.applyAlertsDelayMs)&&void 0!==s?s:300),Promise.resolve();if("sequential"===this._replacementStrategy){const t=(0,et.II)();return this._applyAlertsSequentiallyRequests.next({applyAlertsInfo:e,deferredPromise:t}),t.promise}return this._applyAlerts(e)}removeAlerts(e){try{return e.forEach((({alertId:e,removalReason:t})=>{this._params.alertProcessor.removeAlert(e,{_tag:"alertApplied"===t?qe.i.alertAccepted:qe.i.ignore})})),Promise.resolve()}catch(t){return this._logger.warn("Error removing alerts.",{removeAlertsInfo:e,error:t}),Promise.reject(t)}}scrollAlertIntoView(e){try{return this._params.highlightsScroller.scrollAlertIntoView(e),Promise.resolve()}catch(t){return this._logger.warn("Error scrolling alert into view.",{scrollAlertIntoViewInfo:e,error:t}),Promise.reject(t)}}setAlertsVisibility(e){try{return this._params.highlightsUpdater.setAlertsVisibility(e),Promise.resolve()}catch(t){return this._logger.warn("Error setting alerts visibility.",{alertsVisibilityInfo:e,error:t}),Promise.reject(t)}}updateAlertsVisibility(e){try{return this._params.highlightsUpdater.updateAlertsVisibility(e),Promise.resolve()}catch(t){return this._logger.warn("Error updating alerts visibility.",{alertsVisibilityInfo:e,error:t}),Promise.reject(t)}}dispose(){this._subs.unsubscribe()}}function rt(e){const t={lifecycleService:e.lifecycleService,capiService:e.capiService,uphookService:e.uphookService,feedbackService:e.feedbackService,experimentService:e.experimentService,textEditorService:e.textEditorService,userService:e.userService,notifyAssistantUIAction:e.notifyAssistantUIAction,trackingService:e.trackingService,theme:void 0},i=()=>function(e){const t=M.h.create(e.initialAlertId),i=e.alertStateService.getActiveAlertByClick().pipe(y.U((e=>{var t;return null!==(t=null==e?void 0:e.alertId)&&void 0!==t?t:null}))).subscribe(b.wW(t));return{sduiService:{supportedForms:e.supportedForms,sduiItemCollectionChanges:(s=e.getSDUIBuffer,a=e.inboundCAPIEvents,Ge.z(ze.P((()=>w.of(s()))),a.pipe(v.h((0,B.Kg)(Fe.h.is("sdui_add"),Fe.h.is("sdui_update"),Fe.h.is("sdui_remove"),(0,B.W9)(Fe.h.is("session_started"),(e=>e.isNewSession)))),y.U((e=>[e])))).pipe(y.U(we.UI((e=>{switch(e.kind){case"sdui_add":return(0,He.K5)(e.sduiRootId,e.sdui);case"sdui_update":return(0,He.FE)(e.sduiRootId,e.sdui);case"sdui_remove":return(0,He.Ul)(e.sduiRootId);case"session_started":return(0,He.Sq)();default:return(0,Re.L0)(e)}}))),v.h((e=>e.length>0)),y.U((e=>({changes:e,pendingChangesCount:0})))))},alertService:new at({initialAlertId:e.initialAlertId,alertProcessor:e.alertProcessor,alertStateService:e.alertStateService,replacementServiceInjector:e.replacementServiceInjector,requestAwaitService:e.requestAwaitService,highlightsScroller:e.highlightsScroller,highlightsUpdater:e.highlightsUpdater,getFormattingService:e.getFormattingService,experimentClient:e.experimentClient,dynamicConfig:e.dynamicConfig,textObserver:e.textObserver}),dispose:()=>{e.highlightsUpdater.clearAll(),i.unsubscribe()}};var s,a}({getSDUIBuffer:e.getSDUIBuffer,inboundCAPIEvents:e.inboundCAPIEvents,alertProcessor:e.alertProcessor,initialAlertId:ke(e.openParams),highlightsUpdater:e.highlightsUpdater,highlightsScroller:e.highlightsScroller,replacementServiceInjector:e.replacementServiceInjector,getFormattingService:e.getFormattingService,requestAwaitService:e.requestAwaitService,alertStateService:e.alertStateService,supportedForms:e.supportedForms,experimentClient:e.experimentClient,dynamicConfig:e.dynamicConfig,textObserver:e.textObserver}),s=i=>({...t,kind:"genAI",genAIAvailabilityService:e.genAIAvailabilityService,genAIStartSessionOptions:Pe(i,{disableKnowledgeEngine:!!e.disableKnowledgeEngine||void 0},e.getQuickReplyContext(),e.url),selectionContextAvailabilityService:e.selectionContextAvailabilityService,skillService:e.skillService,notifyGenAISessionStateChanged:t=>e.genAISession.set(t)});return{getGenAIDeps:s,getRevisionDeps:()=>(0,o.zG)(i(),(({alertService:i,sduiService:s,dispose:a})=>({...t,initialView:"genAI"!==e.openParams.assistantMode&&"genAIAndWritingExpert"!==e.openParams.assistantMode&&"emojiButtonSource"===e.openParams.source.kind?"toneReport":void 0,kind:"revision",alertService:i,sduiService:s,toneDetectorService:e.toneDetectorService,settingsOptions:{kind:"withView",getView:()=>e.settingsService.getView()},isPlagiarismEnabled:e.isPlagiarismEnabled,isWritingExpertEnabled:e.isWritingExpertEnabled,dispose:a}))),getGenAIAndWritingExpertDeps:e=>{const{alertService:t,sduiService:a}=i();return{...s(e),kind:"genAIAndWritingExpert",alertService:t,sduiService:a}}}}var nt=i(57757),ot=i(33394),lt=i(85441),ct=i(80544),dt=i(79692),ut=i(67434),pt=i(44586),ht=i(97425),gt=i(43254),mt=i(33148),vt=i(92627),_t=i(99877),ft=i(31874),bt=i(72004),St=i(35298),yt=i(51129);function At(e,t,i){const s="business"===i.previousUserType||"edu"===i.previousUserType||"ngo"===i.previousUserType;let a="free";return s?a="institution":"premium"===i.previousUserType&&(a="premium"),e.anonymous?{kind:"signed-out",institutionType:s?i.previousUserType:void 0,type:a}:{kind:"signed-in",id:e.id,isPremium:yt.n.isPremium(e),dialect:t,email:e.email,institution:(0,o.zG)(U.fromNullable(e.institutionInfo),U.map((({id:e,name:t})=>({id:e,name:t}))))}}function wt(e,t,i){return Ge.z(ze.P((()=>k.D(t()))).pipe(v.h(i)),e)}var It=i(44358);class Ct{constructor(e,t,i){this._gnar=e,this._telemetry=t,this._alertProcessor=i}trackUphookShown(e){switch(e){case"grammarlyGoPrompts":return(0,It.nE)(this._gnar,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),this._telemetry.upgradeHooks.showUpgradeHook("grammarlyGoPrompts","grammarlyGo"),Promise.resolve();case"plagiarism":return(0,It.nE)(this._gnar,{placement:"plagiarismView",upgradeHookName:"plagiarism",upgradeHookSlot:"plagiarismView",upgradeHookVariant:"premium"}),this._telemetry.upgradeHooks.showUpgradeHook("plagiarism","plagiarismView","premium"),Promise.resolve();case"toneDetector":return(0,It.nE)(this._gnar,{placement:"toneDetector",upgradeHookName:"toneDetector",upgradeHookSlot:"emogenieReport",upgradeHookVariant:"premium"}),this._telemetry.upgradeHooks.showUpgradeHook("toneDetector","emogenieReport","premium"),Promise.resolve();default:(0,Re.L0)(e)}}trackUphookClicked(e){switch(e){case"grammarlyGoPrompts":return(0,It.Qi)(this._gnar,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),this._telemetry.upgradeHooks.clickUpgradeHook("grammarlyGoPrompts","grammarlyGo"),Promise.resolve();case"plagiarism":return(0,It.Qi)(this._gnar,{placement:"plagiarismView",upgradeHookName:"plagiarism",upgradeHookSlot:"plagiarismView",upgradeHookVariant:"premium"}),this._telemetry.upgradeHooks.clickUpgradeHook("plagiarism","plagiarismView","premium"),Promise.resolve();case"toneDetector":return(0,It.Qi)(this._gnar,{placement:"toneDetector",upgradeHookName:"toneDetector",upgradeHookSlot:"emogenieReport",upgradeHookVariant:"premium"}),this._telemetry.upgradeHooks.clickUpgradeHook("toneDetector","emogenieReport","premium"),Promise.resolve();default:(0,Re.L0)(e)}}trackUphookDismissed(e){if("plagiarism"===e)return(0,It.jc)(this._gnar,{placement:"plagiarismView",upgradeHookName:"plagiarism",upgradeHookSlot:"plagiarismView",upgradeHookVariant:"premium"}),Promise.resolve();(0,Re.L0)(e)}executeUphook(e){const t="advancedIssues"===e?Array.from(this._alertProcessor.alerts.getAll()).filter(je.S.isCapiAlert).filter((e=>!e.isFree&&e.isHidden)):[];return(0,lt.OB)().bgRpc.api.openSubscriptionPage({currentAlerts:t,utmCampaign:"toneDetector"===e?"toneSuggestion":e}),Promise.resolve()}}var Rt=i(71249),xt=i(32057);const kt={"Style/ToneImprovement/ConfidentRewrite/ToneAI":"1f91d","Style/ToneImprovement/PersonableRewrite/ToneAI":"1f917","Style/ToneImprovement/PositiveFraming/ToneAI":"1f64c"};function Pt(e){var t,i,s;const a=null!==(t=e.extraProperties.emoji_id)&&void 0!==t?t:e.extraProperties.emojiId,r=e.minicardTitle.match(xt.V),n=r&&r[0]&&(null===(i=r[0].codePointAt(0))||void 0===i?void 0:i.toString(16)),o=kt[e.patternName];return U.fromNullable(null!==(s=null!=a?a:n)&&void 0!==s?s:o)}class Et{constructor(e){this._alertProcessor=e}getToneAlertsSummary(){const e=Array.from(function*(e){for(const t of e)je.S.isCapiAlert(t)&&t.patternName.startsWith("Style/ToneImprovement")&&(yield t)}(this._alertProcessor.alerts.getAll())).map((e=>({title:e.minicardTitle.replace(xt.V,"").trim(),emojiId:Pt(e)}))),t=new Set(e.map((({title:e})=>e)));return Promise.resolve((0,o.zG)(Rt.YM(e),U.map((({title:e,emojiId:i})=>({title:t.size>1?"Strike the right tone":e,emojiId:i})))))}}function Ut(e,t,i,s,a,n,l,c,d,h,m,f,b,R,x,k,P,E,B,O,T,N,D,F,G,z,H,q,V,W,j,L,Q,K,Z){const Y=new p.xQ,$=new gt.t({inboundCAPIMessages:wt(t,i,mt.J4),sendCAPIMessage:({action:t,data:i,shouldInjectRev:s,shouldInjectSessionId:a})=>(0,o.zG)(r.Uo((0,o.zG)(e.get(),Ke.fromOption((()=>new Error("checking service not initialized"))))),r.tS((e=>e.sendMessage(t,i,s,a))))}),X={user:M.h.combine(s,n,a,At),setDialect:l,signIn:()=>{const e=(0,lt.OB)().browserApi;e.beginOAuth?e.beginOAuth():self.open((0,ot.s7)("signedOutUI"),"_blank","noreferrer")}},J=new vt.L($,M.h.combine(L.view((e=>{var t;return!1===(null===(t=null==e?void 0:e.status)||void 0===t?void 0:t.cheetahEnabled)})),h.view(U.chain((e=>U.fromNullable(e.cheetahState)))),((e,t)=>(0,o.zG)(t,U.filter((()=>!e)),U.fold((()=>({enabled:!1})),(e=>({enabled:!0,userState:e}))))))),ee=m.pipe(ct.QV(dt.E),ut.R(((e,t)=>{const i=e.filter(Bt);return t&&Bt(t)?[...i,t]:i}),[]),y.U(we.Z$),Be.shareReplay({bufferSize:1,refCount:!0})),te=S.aj([ee,f,b]).pipe(y.U((([e,t,i])=>(0,o.zG)(e,U.filter((()=>t)),U.fold((()=>({})),(e=>({[_t.n.initialPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[_t.n.initialBTSPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0}))))))),ie=e=>{null==Z||Z.debug(`Completing step [${e}]`);x.get()[e].extension.completed||k({[e]:{completed:!0,lastSeen:Date.now()}})},se={flush:()=>r.fF((()=>new pt.y((t=>{const i=new u.w;return E.empty.get()?t.next(void 0):(E.flush(),(0,o.zG)(e.get(),U.fold((()=>t.next(void 0)),(e=>{i.add(e.messages.pipe(v.h((e=>e._tag===pe.J8.Type.submitOtAck)),ht.L(500,w.of(null)),A.b((()=>t.next(void 0)))).subscribe())})))),()=>i.unsubscribe()})).pipe(_.q(1)).toPromise())),getText:e=>r.tD((()=>B(e))),insertText:e=>r.tD((()=>O(e))),copyText:e=>(0,nt.vQ)(e),setContextHighlight:(e,t)=>{z.set(U.some({range:e,visibility:t}))},selectedRange:T,textUpdated:G,trimmedTextLength:G.pipe(C.O(null),y.U((()=>B({start:0,end:Number.MAX_SAFE_INTEGER}).trim().length)),I.x(),Be.shareReplay({refCount:!0,bufferSize:1}))},ae=new Ct(H,V,Q),re={domain:w.of(q),submitFeedback:e=>r.Y3((()=>(0,o.zG)(e.source,(e=>e===bt.x.Source.resultCard?"cheetah-card":e===bt.x.Source.quickReplyInitialActions||e===bt.x.Source.intentCard?"cheetah-quick-reply":void(0,Re.L0)(e)),(t=>H.feedbackFormSubmit(e.mood,t,e.domain,e.message)))),(e=>new Error(String(e))))},ne=new St.j(M.h.create({contextUpdatesClient:W.isGateEnabled(he.K.CheetahSelectionContextUpdates)&&"test"===W.getTreatment(Ze.p.CheetahSelectionContextUpdates),contextUpdatesServer:W.isGateEnabled(he.K.CheetahSelectionContextUpdatesServer)&&"test"===W.getTreatment(Ze.p.CheetahSelectionContextUpdates)})),oe=new Et(Q);let le;return{capiService:$,userService:X,genAIAvailabilityService:J,textEditorService:se,feedbackService:re,uphookService:ae,selectionContextAvailabilityService:ne,toneDetectorService:oe,experimentService:undefined,skillService:le,createOnboardingViewModels:()=>{const e=new Set;P.get().compose||e.add(ve.T.StepName.initial),P.get().onboarding||(e.add(ve.T.StepName.initial),e.add(ve.T.StepName.initialBTS),e.add(ve.T.StepName.prompts),e.add(ve.T.StepName.review),e.add(ve.T.StepName.knowledgeHub),e.add(ve.T.StepName.references));const t=(0,o.zG)(h.get(),U.map((e=>"ASSIGNMENT_WRITING"===e.defaultDocumentContext.writingIntent)),U.getOrElse(o.jv));return P.get().onboardingBTS&&t||e.add(ve.T.StepName.initialBTS),P.get().knowledgeHubIntegration||e.add(ve.T.StepName.knowledgeHub),(0,ft.Q)({capiService:$,upstreamOnboardingState:x,session:c.pipe(g.w(U.fold((()=>w.of(U.none)),(e=>e.genAISession)))),textStats:d,forceDisabledOnboardingSteps:e,assistantUIActions:Y,externalElements:te,hideAssistantOnboardingTooltips:c.pipe(g.w(U.fold((()=>M.h.create(!1)),(e=>e.dragBehavior.pipe(y.U((e=>"draggable"===e.kind&&e.isDragging))))))),promptsAllocated:J.availability.view(me._.getPromptsAllocated),client:"extension",disposed:R,completeOnboardingStep:ie})},notifyAssistantUIAction:e=>Y.next(e),dispose:()=>{J.dispose(),ne.dispose()}}}function Bt(e){return e.isConnected&&null!==e.offsetParent}const Ot=(Tt=(0,lt.OB)().experimentClient,function(e){if("mergedSharedAssistant"===e)return"genAIAndRevision";if("splitSharedAssistants"===e)return"genAI";{const e=Tt.isGateEnabled(he.K.WritingExpertPullMode),t=Tt.isGateEnabled(he.K.WritingExpertInAssistantInternal),i=Tt.isGateEnabled(he.K.WritingExpertInAssistantNative);return e&&(t||i)?"genAIAndWritingExpert":"genAI"}});var Tt;function Mt(e,t,i){const s={source:i,genAIParams:{genAISessionMode:t}};switch(e){case"genAIAndRevision":return{assistantMode:"genAIAndRevision",...s};case"genAI":return{assistantMode:"genAI",...s};case"genAIAndWritingExpert":return{assistantMode:"genAIAndWritingExpert",...s};default:(0,Re.L0)(e)}}var Nt=i(97583);const Dt="extension-assistant-visually-ready",Ft="extension-assistant-interaction-ready",Gt=`${Nt.V.assistantOpenAttempt}-to-extension-assistant-visually-ready`;class zt{constructor(e){this._params=e,this.sizeBehavior=this._params.sizeBehavior,this.dragBehavior=this._params.dragBehavior,this.hostInfo=this._params.hostInfo}static markOpenAttempt(){performance.mark(Nt.V.assistantOpenAttempt)}static markVisuallyReady(){performance.mark(Dt)}static markInteractionReady(){performance.mark(Ft)}static measureOpenAttemptToVisuallyReady(){try{return performance.measure(Gt,Nt.V.assistantOpenAttempt).duration}catch(e){return}}static measureVisuallyReadyToInteractionReady(){try{return performance.measure("extension-assistant-visually-ready-to-extension-assistant-interaction-ready",Dt).duration}catch(e){return}}starting(){return Promise.resolve()}visuallyReady(){zt.markVisuallyReady();const e=zt.measureOpenAttemptToVisuallyReady();return this._params.gnarTracking.trackVisuallyReady(e),this._params.onVisuallyReady(),Promise.resolve()}interactionReady(e){zt.markInteractionReady();const t=zt.measureVisuallyReadyToInteractionReady();return this._params.gnarTracking.trackInteractionReady(e,t),Promise.resolve()}focusStateChanged(e){return this._params.onFocusStateChanged(e),Promise.resolve()}readyToDrag(e){return this._params.onReadyToDrag(e)}close(){return this._params.gnarTracking.trackClose(),this._params.onClose(),Promise.resolve()}openUrl(e){return self.open(e,"_blank","noreferrer"),Promise.resolve()}dispose(){this._params.gnarTracking.dispose()}}var Ht=i(40327),qt=i(32065);function Vt(e){return"revision"===e.assistantMode||"genAIAndRevision"===e.assistantMode}function Wt(e,t){return e instanceof qt.P&&Vt(t)}var jt=i(70063);class Lt{constructor(e){var t,i;this._params=e,this._subs=new u.w,this._source=function(e){switch(e.kind){case"gButtonSource":return"gbutton";case"emojiButtonSource":return"tone";case"inlineCardSource":return"inline-card";case"inlinePushRewriteSource":return"inline-push-rewrite";case"inlineQuickReplySource":return"inline-quick-reply";case"inlineQuickRewriteSource":return"inline-quick-rewrite";case"inlineRewriteSource":return"inline-rewrite";case"onboardingSource":return"onboarding";default:(0,Re.L0)(e)}}(this._params.openAssistantParams.source),this._uiType=(t=this._params.openAssistantParams,i=this._params.supportedForms,Vt(t)?void 0!==i&&i.length>0&&"longForm"===i[0]?"long-form":"short-form":"cheetah"),this._startTrackingDrag()}trackVisuallyReady(e){const t=this._params.statisticsService.alertCounts.get(),i=this._params.statisticsService.wordsCount.get(),s=t.filter((e=>je.S.isCapiAlert(e)&&e.outcome===pe.TC.clarity)).visibleCapiAlerts;if(Wt(this._params.integration,this._params.openAssistantParams))this._params.gnar.gdocsSidebarGdocsSidebarShow(this._params.integration.isDocOwnedByCurrentUser(),"user",t.unmutedCapiAlerts,i,t.visibleInlineCapiAlerts,s,t.visibleNotInlineCapiAlerts,void 0,e,this._source,this._uiType);else{const a=this._params.position.get();this._params.gnar.assistantPopupShow("default",this._params.height.get(),a.left,a.top,t.unmutedCapiAlerts,s,t.visibleInlineCapiAlerts,t.filter((e=>je.S.isCapiAlert(e)&&"priority"===e.assistantView)).unmutedCapiAlerts,i,"sticky",this._getSessionUuid(),void 0,e,this._params.statisticsService.generalScore.get(),this._source,this._uiType)}}trackInteractionReady(e,t){Wt(this._params.integration,this._params.openAssistantParams)?this._params.gnar.gdocsSidebarGdocsSidebarReady(this._getSessionUuid(),e.success,"gen-ai"===e.kind?"genai":"revision",t,this._source,this._uiType):this._params.gnar.assistantPopupReady(this._getSessionUuid(),e.success,"gen-ai"===e.kind?"genai":"revision",t,this._source,this._uiType)}trackClose(){const e=this._params.statisticsService.alertCounts.get(),t=e.filter((e=>je.S.isCapiAlert(e)&&e.outcome===pe.TC.clarity)).visibleCapiAlerts;Wt(this._params.integration,this._params.openAssistantParams)?this._params.gnar.gdocsSidebarGdocsSidebarClose(this._params.integration.isDocOwnedByCurrentUser(),"user",e.unmutedCapiAlerts,this._params.statisticsService.wordsCount.get(),e.visibleInlineCapiAlerts,t,e.visibleNotInlineCapiAlerts):this._params.gnar.assistantPopupCloseButtonClick("default",e.unmutedCapiAlerts,t,e.visibleInlineCapiAlerts,e.filter((e=>je.S.isCapiAlert(e)&&"priority"===e.assistantView)).unmutedCapiAlerts,void 0)}_startTrackingDrag(){const e=this._params.position.get();let t=e;this._subs.add(this._params.isDragging.pipe(R.G(),v.h((([e,t])=>e&&!t))).subscribe((()=>{const i=this._params.position.get();jt.E9.l1Distance(i,t)<Lt.MINIMAL_RECOGNIZABLE_DRAG_DISTANCE||(this._params.gnar.assistantPopupDrag(i.left,i.top,this._params.height.get(),e.left,e.top),t=i)})))}_getSessionUuid(){return(0,Ht.pipe)(this._params.checkingService.get(),U.chain((e=>U.fromNullable(e.sessionUuid))),U.fold((()=>""),(e=>e)))}dispose(){this._subs.unsubscribe()}}function Qt(e){var t,i;return null!==(i=null===(t=U.toNullable(e.get()))||void 0===t?void 0:t.sessionUuid)&&void 0!==i?i:void 0}Lt.MINIMAL_RECOGNIZABLE_DRAG_DISTANCE=10;const Kt=(0,T.xb)(G.G),Zt=new Set(["loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","noPaymentMethodSubscription","grammarlyBusinessSigninPopup","gdocsFeedbackUI"]),Yt=new Set(["loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","grammarlyBusinessSigninPopup"]);function $t(e){return"opened"===e.kind}function Xt(e){return $t(e)&&"revision"!==e.assistantMode}class Jt{constructor(e){this._params=e,this._subs=new u.w,this._log=d.Y.create("CheetahFeatureImpl"),this._inlineButtonUI=M.h.create(null),this._ideateButtonUI=M.h.create(null),this._expandedIdeateButtonUI=M.h.create(null),this._assistantUI=M.h.create(null),this._highlightUI=M.h.create(null),this._quasiCaretUI=M.h.create(null),this._onboardingUI=M.h.create(null),this._nativeCursorHider=M.h.create(U.none),this._contextHighlight=M.h.create(U.none),this._highlightsUpdater=new Ne({getAlertById:e=>this._params.alertProcessor.alerts.getAlertById(e),aquaAlertsWiring:this._params.aquaAlertsWiring,alertStateService:this._params.alertStateService,logger:d.Y.create("cheetah.revision.highlights")}),this._highlightsScroller=new De({integration:this._params.integration,getAlertById:e=>this._params.alertProcessor.alerts.getAlertById(e)}),this._ideateButtonTooltipNotificationState=M.h.create(U.none),this._assistantFocused=M.h.create(!1),this._inlineButtonRecentlyPressed=M.h.create(!1),this._ideateButtonRecentlyHovered=M.h.create(!1),this._selectionRange=M.h.create(U.none),this._highlights=M.h.create([]),this._quasiCaretRect=M.h.create(U.none),this._assistantUIState=M.h.create(U.none),this._onboardingViewModels=M.h.create(U.none),this._ideateButtonRefChange=new p.xQ,this._disposed=new p.xQ,this._initialOnboardingBlockedForSession=M.h.create(!1),this._inboundCAPIEvents=new p.xQ,this._assistantServices=Ut(this._params.checkingService,this._params.checkingService.pipe(h.oA,g.w((e=>e.capiMessages))),(()=>Object.values(this._params.latestCAPIMessages.get())),this._params.user,this._params.csPageState,this._params.dapiSettings.view((e=>{var t,i;return null!==(i=null!==(t=e.dialectStrong)&&void 0!==t?t:e.dialectWeak)&&void 0!==i?i:"american"})),(e=>r.fF((()=>this._params.dapiActions.changeStrongDialect(e)))),this._assistantUIState,this._params.textStats,this._params.capiStartAckMessage,this._ideateButtonRefChange,M.h.combine(this._params.integration.canShowIdeateButtonPopups,this._params.gButtonPopupState.view("type").view((e=>!Zt.has(e))),B.xD),M.h.combine(this._params.csPageState.view("cheetah").view((e=>(null==e?void 0:e.canShowInitialOnboarding)||(null==e?void 0:e.canShowInitialBTSOnboarding)||!1)),this._initialOnboardingBlockedForSession,((e,t)=>e&&!t)),m.T(this._params.csPageState.view("isActiveTab").pipe(v.h((e=>!e))),this._disposed).pipe(_.q(1)),this._params.dapiSettings.view((e=>function(e){const t=ge.Z.State.toClientState(ge.Z.decode(e.extension||""),"extension"),i=ge.Z.State.toClientState(ge.Z.decode(e.editor||""),"editor"),s=ge.Z.State.toClientState(ge.Z.decode(e.llamaMac||""),"llamaMac"),a=ge.Z.State.toClientState(ge.Z.decode(e.llamaWindows||""),"llamaWin");return(0,o.zG)(ge.Z.State.empty,ge.Z.State.patch(t,"extension"),ge.Z.State.patch(i,"editor"),ge.Z.State.patch(s,"llamaMac"),ge.Z.State.patch(a,"llamaWin"))}({extension:e["cheetah:onboardingState"],editor:e["cheetah:onboardingState:editor"],llamaMac:e["cheetah:onboardingState:llamaMac"],llamaWindows:e["cheetah:onboardingState:llamaWindows"]}))),(e=>{this._params.dapiActions.modifyCheetahOnboardingState((0,o.ls)(ge.Z.decode,(t=>(0,o.zG)(ge.Z.State.toClientState(t,"extension"),(t=>({...t,...e})),(e=>ge.Z.State.patch(e,"extension")(t)))),ge.Z.encode))}),this._params.featureFlags,this._params.textChangeBuffer,(e=>this._params.integration.getText(e)),(e=>this._insertText(e)),this._selectionRange,this._params.textObserver,this._params.selectionService,this._params.replacementServiceInjector,this._params.integration.textUpdated,this._contextHighlight,this._params.gnar,this._params.domain,this._params.telemetry,this._params.experimentClient,this._params.integration.appActionsConfig.get(),this._params.csPageState.view("cheetah"),this._params.alertProcessor,this._params.integration.gOSCustomizationConfig.get(),this._log),this._isOnboardingPopupVisible=M.h.create(!1),this._entryPointsEnabled=M.h.create(!1),this._openAssistantSubject=new p.xQ,this._assistantApplet=M.h.create(null),this._latestOpenAssistantParams=null,this.preloadUI=this._assistantApplet.view((e=>null==e?void 0:e.preloadUI)),this.inlineButtonUI=this._inlineButtonUI.view(),this.ideateButtonUI=this._ideateButtonUI.view(),this.expandedIdeateButtonUI=this._expandedIdeateButtonUI.view(),this.assistantUI=this._assistantUI.view(),this.highlightUI=this._highlightUI.view(),this.quasiCaretUI=this._quasiCaretUI.view(),this.onboardingUI=this._onboardingUI.view(),this.assistantState=this._assistantUI.view((0,o.ls)(U.fromNullable,U.chain((()=>{var e;return U.fromNullable(null===(e=this._latestOpenAssistantParams)||void 0===e?void 0:e.assistantMode)})),U.fold((()=>({kind:"closed"})),(e=>({kind:"opened",assistantMode:e}))))),this.isOnboardingPopupVisible=this._isOnboardingPopupVisible.view(),this.isAvailable=M.h.combine(this._assistantServices.genAIAvailabilityService.availability.view((0,B.ff)(me._.isUnavailable)),this._params.csPageState.view("cheetah"),((e,t)=>{var i;return e&&!0===(null===(i=null==t?void 0:t.status)||void 0===i?void 0:i.cheetahEnabled)})),this.userSettings=this._assistantServices.genAIAvailabilityService.availability.view((e=>e.kind===me._.Kind.disabled||e.kind===me._.Kind.unavailable?{inlineQuickReplyEnabled:!1,inlineRewriteEnabled:!1}:e.userSettings)),this._params.dapiActions.reloadPropsRateLimited(),this._subs.add(this._params.checkingService.pipe(h.oA,g.w((e=>e.capiEvents))).subscribe(this._inboundCAPIEvents)),this._subs.add(this._params.checkingService.pipe(h.oA,g.w((e=>e.readyState)),v.h((e=>e===pe.kQ.ready||e===pe.kQ.firstTextCheckCompleted)),_.q(1)).subscribe((()=>this._init()))),this._subs.add(this._setupIdeateTooltipStateObs());const t=this._onboardingViewModels.pipe(g.w(U.fold((()=>f.E),(e=>e.onboarding.uiActions))));this._subs.add(t.pipe(v.h(ii)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialOnboardingShown()}))),this._subs.add(t.pipe(v.h(si)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialBTSOnboardingShown()}))),this._subs.add(this._getOnboardingVMStepActive([ve.T.StepName.initial,ve.T.StepName.initialBTS]).subscribe(b.wW(this._isOnboardingPopupVisible))),this._subs.add(this._params.gButtonPopupState.view("type").view((e=>Yt.has(e))).subscribe((e=>{e&&this._initialOnboardingBlockedForSession.set(!0)}))),this._subs.add(S.aj([this._params.gButtonDisabledReason,this._params.integration.entryPointsEnabled]).pipe(y.U((([e,t])=>t&&!function(e){const t=new Set([Ae.P.DATA_CONTROL_ACTIVE,Ae.P.OFFLINE,Ae.P.STAND_WITH_UKRAINE,Ae.P.USER_CLAIMED,Ae.P.USER_EDC_BLOCKED,Ae.P.SIGNED_OUT_GB,Ae.P.INACTIVE_INTEGRATION]);return null!==e&&t.has(e)}(e)))).subscribe(b.wW(this._entryPointsEnabled))),this._subs.add(this._params.csPageState.view("cheetah").view((e=>{var t;return!1===(null===(t=null==e?void 0:e.status)||void 0===t?void 0:t.cheetahEnabled)})).pipe(v.h((()=>{var e;return"genAI"===(null===(e=this._latestOpenAssistantParams)||void 0===e?void 0:e.assistantMode)}))).subscribe((()=>this._closeAssistant(ye.jg.disposed)))),this._registerDebugHelpers(),this._setupAssistantAppletInstance()}_setupAssistantAppletInstance(){0}closeAssistant(e){this._closeAssistant(e)}getHoveredStateBehavior(e){return this._highlightsUpdater.getHighlightVisualState(e)}getAlertsFilter(){return this._highlightsUpdater.alertsFilter}suggestStartSessionMode(){const e=this._params.featureFlags.get();return(0,o.zG)(this._params.integration.selectionRange.get(),U.filter((t=>ti(t)&&e.rewrite)),U.fold((()=>"ideation"),(()=>"rewrite")))}_isMergedAssistantEnabled(){return"mergedSharedAssistant"===this._params.sharedAssistantTreatment}_init(){this._subs.add(this._assistantFocused.subscribe((e=>this._log.debug("Assistant "+(e?"focused":"blurred"))))),this._subs.add(this._openAssistantSubject.pipe(g.w((e=>(this._latestOpenAssistantParams=e,this._openAssistant(e))))).subscribe()),this._subs.add(this._params.openAssistant.subscribe(this._openAssistantSubject)),this._subs.add(this._getInlineButtonUI().subscribe(b.wW(this._inlineButtonUI))),this._subs.add(this._getIdeateButtonUI().subscribe(b.wW(this._ideateButtonUI))),this._subs.add(this._getExpandedIdeateButtonUI().subscribe(b.wW(this._expandedIdeateButtonUI))),this._subs.add(this._getHighlightUI().subscribe(b.wW(this._highlightUI))),this._subs.add(this._getQuasiCaretUI().subscribe(b.wW(this._quasiCaretUI))),this._subs.add(this._getOnboardingUI().subscribe(b.wW(this._onboardingUI))),this._subs.add(this._updateSelectionRange().subscribe(b.wW(this._selectionRange))),this._subs.add(this._updateHighlightRects().subscribe(b.wW(this._highlights))),this._subs.add(this._updateQuasiCaretRect().subscribe(b.wW(this._quasiCaretRect))),this._subs.add(this._updateNativeCursor().subscribe()),this._subs.add(this.assistantState.subscribe((e=>{$t(e)&&this._params.closeLegacyAssistant()}))),this._subs.add(this._createOnboardingViewModelWhenCheetahAvailable().subscribe()),this._subs.add(this._handleTryItOut().subscribe())}_handleTryItOut(){return this._onboardingViewModels.pipe(g.w(U.fold((()=>f.E),(e=>e.onboarding.uiActions))),v.h(_e.l.is(_e.l.Kind.tryItOut)),A.b((()=>this._openAssistantSubject.next({assistantMode:Ot(this._params.sharedAssistantTreatment),source:{kind:"onboardingSource"},genAIParams:{genAISessionMode:ei(this._params.integration.quickReplyContext.get())&&this._params.featureFlags.get().quickReply?"quickReply":"ideation"}}))))}_getOnboardingVMStepActive(e){return this._onboardingViewModels.pipe(g.w(U.fold((()=>w.of(!1)),(t=>t.onboarding.activeStep.view((0,o.ls)(U.filter((e=>e.show)),U.map((t=>e.includes(t.name))),U.getOrElse(o.jv)))))),I.x())}_setupIdeateTooltipStateObs(){return this._assistantServices.genAIAvailabilityService.availability.pipe(C.O(null),R.G(),y.U((([e,t])=>e&&t&&me._.isPassive(e)&&me._.isActive(t)?U.some("You’ve got prompts!"):U.none)),g.w(U.fold((()=>w.of(U.none)),(e=>m.T(w.of(U.some(e)),w.of(U.none).pipe(x.g(3e3))))))).subscribe(b.wW(this._ideateButtonTooltipNotificationState))}_registerDebugHelpers(){!function(e){const t=self;t&&(t.cheetahDebug=t.cheetahDebug||{},Object.assign(t.cheetahDebug,e))}({clearOnboarding:()=>this._params.dapiActions.modifyCheetahOnboardingState((()=>ge.Z.encode(ge.Z.State.empty)))})}_createOnboardingViewModelWhenCheetahAvailable(){return M.h.combine(this._params.featureFlags,this._assistantServices.genAIAvailabilityService.availability.view(me._.isUsable),((e,t)=>e.onboarding&&t)).pipe(A.b((e=>this._onboardingViewModels.modify((t=>((0,o.zG)(t,O.bw((e=>e.onboarding.dispose()))),e?U.some(this._assistantServices.createOnboardingViewModels()):U.none))))))}_onClickIdeateButton(e){$t(this.assistantState.get())?this._closeAssistant(ye.jg.closed):this._openAssistantSubject.next({assistantMode:Ot(this._params.sharedAssistantTreatment),source:{kind:"gButtonSource"},genAIParams:{genAISessionMode:e}})}_updateSelectionRange(){return S.aj([this._params.integration.selectionRange,this.assistantState.view($t)]).pipe(y.U((([e,t])=>({selectionRange:e,assistantIsFocused:this._assistantFocused.get(),inlineButtonRecentlyPressed:this._inlineButtonRecentlyPressed.get(),ideateButtonRecentlyHovered:this._ideateButtonRecentlyHovered.get(),initialPopupOnboardingStepIsActive:this.isOnboardingPopupVisible.get(),assistantOpened:t}))),A.b((({inlineButtonRecentlyPressed:e,ideateButtonRecentlyHovered:t})=>{e&&this._inlineButtonRecentlyPressed.set(!1),t&&this._ideateButtonRecentlyHovered.set(!1)})),v.h((({selectionRange:e,assistantIsFocused:t,inlineButtonRecentlyPressed:i,ideateButtonRecentlyHovered:s,initialPopupOnboardingStepIsActive:a,assistantOpened:r})=>!i&&!s&&(!r||(!U.isNone(e)||!t&&!a)))),y.U((({selectionRange:e})=>e)))}_updateHighlightRects(){return e=this._selectionRange,t=this._contextHighlight,i=this._params.integration,S.aj([e.pipe(g.w(U.fold((()=>w.of([])),(e=>i.getHighlightRects(e).pipe(y.U((e=>e.map((e=>({rect:e,visibility:"visible"})))))))))),t.pipe(g.w(U.fold((()=>w.of([])),(e=>i.getHighlightRects(e.range).pipe(y.U((t=>t.map((t=>({rect:t,visibility:e.visibility}))))))))))]).pipe(y.U((([e,t])=>t.find((e=>"hidden"!==e.visibility))?t:e)));var e,t,i}_updateQuasiCaretRect(){return S.aj([this._selectionRange,this._highlightsUpdater.hasHighlights]).pipe(g.w((([e,t])=>(0,o.zG)(e,U.filter((()=>!t)),U.filter(c.SV.isCollapsed),U.fold((()=>w.of([])),(e=>this._params.integration.getHighlightRects(e)))))),y.U((e=>(0,o.zG)(e,a.c2,U.map((e=>e[e.length-1]))))))}_updateNativeCursor(){return M.h.combine(this._quasiCaretRect,this._params.experimentClient.isGateEnabled(he.K.UnfixFast570)?this.assistantState.view($t):this.assistantState.view(Xt),((e,t)=>(0,o.zG)(s.Y(U.option)({nativeUIHider:U.fromNullable(this._params.integration.createNativeUIHider),quasiCaretRect:e}),U.filter((()=>t)),O.ew((()=>{this._nativeCursorHider.modify((e=>((0,o.zG)(e,O.bw((e=>e.dispose()))),U.none)))})),O.bw((({nativeUIHider:e})=>{this._nativeCursorHider.modify((t=>((0,o.zG)(t,O.bw((e=>e.dispose()))),U.some(e()))))})))))}_closeAssistant(e){var t,i;this._assistantUIState.set(U.none),this._assistantUI.set(null),e!==ye.jg.closed&&e!==ye.jg.assistantBlurred||this._params.integration.focusTextField(),null===(t=this._params.assistantDidClose)||void 0===t||t.next(null===(i=this._latestOpenAssistantParams)||void 0===i?void 0:i.assistantMode)}async _openAssistant(e){zt.markOpenAttempt(),$t(this.assistantState.get())&&this._closeAssistant(ye.jg.disposed),this._assistantFocused.set(!0),"revision"!==e.assistantMode&&"pushRewrite"===e.genAIParams.genAISessionMode&&this._selectionRange.set(U.some(e.genAIParams.transformRange));try{const t=await this._params.getHostInfo(),i=await this._params.integration.renderAssistant((({sizeBehavior:i,dragBehavior:s,readyToDrag:a})=>{const r=k.D(s).pipe(y.U((e=>"draggable"===e.kind&&e.isDragging))),{assistantHeight:n,assistantPosition:c,isPlagiarismEnabled:d,isWritingExpertEnabled:u}=this._params.integration,{gnar:p,checkingService:h,statisticsService:g}=this._params,m=new Lt({isDragging:r,height:n,position:c,gnar:p,checkingService:h,statisticsService:g,integration:this._params.integration,openAssistantParams:e,supportedForms:this._params.supportedForms}),v=new zt({sizeBehavior:i,dragBehavior:s,hostInfo:t,gnarTracking:m,onFocusStateChanged:e=>this._assistantFocused.set(e.isFocused),onReadyToDrag:e=>a(e),onVisuallyReady:()=>{var t;return null===(t=this._params.assistantDidOpen)||void 0===t?void 0:t.next(e.assistantMode)},onClose:()=>this._closeAssistant(ye.jg.closed)}),_=M.h.create(U.none),f=function(e,t,i=!1){return{feedSuccessStateShown:(i,s)=>{e.assistantSuccessStateShow(i,s,Qt(t))},feedFormChanged:(i,s,a)=>{switch(i){case"shortForm":e.assistantSwitchToShortFormClick(s||void 0,null===a?void 0:a,Qt(t));break;case"longForm":e.assistantSwitchToLongFormClick(s||void 0,null===a?void 0:a,Qt(t));break;default:(0,Re.L0)(i)}},toneReportShown:({tones:i,brandTonesEnabled:s})=>{var a,r;e.emogenieReportShow(i.map((({name:e,confidence:t,prevalence:i})=>({name:e,confidence:t,prevalence:i}))),s,i.length,null!==(r=null===(a=U.toNullable(t.get()))||void 0===a?void 0:a.sessionUuid)&&void 0!==r?r:"")},feedLensShown:i=>{e.assistantLensShow(i,Qt(t))},feedLensButtonClicked:i=>{e.assistantLensButtonClick(i,Qt(t))},actionButtonClicked:(i,s,a,r,n)=>{e.assistantActionButtonClick(i,s,a,r,n,Qt(t))},moreActionsButtonClicked:(i,s,a)=>{e.assistantMoreActionsButtonClick(i,s,a,Qt(t))},actionButtonRendered:(s,a,r,n,o)=>{i&&e.assistantActionButtonRender(s,a,r,n,o,Qt(t))},actionButtonShown:(s,a,r,n,o)=>{i&&e.assistantActionButtonImpression(s,a,r,n,o,Qt(t))},plagiarismCitationsStyleChanged:i=>{e.assistantPlagiarismCitationsStyleChange(i,Qt(t))},plagiarismCitationsStyleDropdownOpened:i=>{e.assistantPlagiarismCitationsStyleDropdownOpen(i,Qt(t))},selectionContextHovered:()=>{e.assistantSelectionContextHover(Qt(t))},selectionContextClicked:()=>{e.assistantSelectionContextClick(Qt(t))},selectionContextRemoveButtonClicked:()=>{e.assistantSelectionContextRemoveButtonClick(Qt(t))}}}(p,h,this._params.experimentClient.isGateEnabled(he.K.CheetahProfuseEventsTracking)),{getGenAIDeps:b,getRevisionDeps:S,getGenAIAndWritingExpertDeps:A}=rt({openParams:e,genAISession:_,lifecycleService:v,capiService:this._assistantServices.capiService,uphookService:this._assistantServices.uphookService,feedbackService:this._assistantServices.feedbackService,experimentService:this._assistantServices.experimentService,textEditorService:this._assistantServices.textEditorService,userService:this._assistantServices.userService,notifyAssistantUIAction:this._assistantServices.notifyAssistantUIAction,getSDUIBuffer:this._params.getSDUIBuffer,inboundCAPIEvents:this._inboundCAPIEvents,alertProcessor:this._params.alertProcessor,initialAlertId:ke(e),highlightsUpdater:this._highlightsUpdater,highlightsScroller:this._highlightsScroller,replacementServiceInjector:this._params.replacementServiceInjector,getFormattingService:this._params.getFormattingService,requestAwaitService:this._params.requestAwaitService,alertStateService:this._params.alertStateService,supportedForms:this._params.supportedForms,isSharedAssistantEnabled:null!==this._params.sharedAssistantTreatment,selectionContextAvailabilityService:this._assistantServices.selectionContextAvailabilityService,toneDetectorService:this._assistantServices.toneDetectorService,settingsService:this._params.settingsService,genAIAvailabilityService:this._assistantServices.genAIAvailabilityService,url:this._params.url,disableKnowledgeEngine:"disabled"===this._params.dapiSettings.get().serengetiState,getQuickReplyContext:()=>this._params.integration.quickReplyContext.get(),experimentClient:this._params.experimentClient,dynamicConfig:this._params.dynamicConfig,skillService:this._assistantServices.skillService,isPlagiarismEnabled:d,isWritingExpertEnabled:u,trackingService:f,textObserver:this._params.textObserver}),w=(0,fe.S)((0,o.zG)(e,(e=>{switch(e.assistantMode){case"genAI":return{dispose:o.Q1,...b(e.genAIParams)};case"revision":return S();case"genAIAndRevision":return(0,o.zG)(S(),(t=>({...b(e.genAIParams),...t,kind:"genAIAndRevision",capiService:this._assistantServices.capiService})));case"genAIAndWritingExpert":return{dispose:o.Q1,...A(e.genAIParams)}}}),(e=>({...e,theme:M.h.create({useIframeTextfieldWrapper:this._params.experimentClient.isGateEnabled(he.K.OggyIframeWrappers)}),dispose:()=>{e.dispose(),v.dispose(),this._assistantFocused.set(!1)}}))));return this._assistantUIState.set(U.some({genAISession:_,dragBehavior:k.D(s)})),l.createElement(w,null)}),e.assistantMode);this._assistantUI.set(l.createElement($,null,i))}catch(e){this._log.error("failed to open assistant",e),this._assistantUIState.set(U.none),this._assistantUI.set(null)}}_getInlineButtonUI(){return(0,o.zG)(s.Y(n.P)({inlineButtonInfo:this._params.integration.inlineButtonPlacement,selectionRange:this._selectionRange,selectionOngoing:m.T(this._params.integration.selectionRange.pipe(y.U((e=>(0,o.zG)(e,U.isSome)))),this._params.integration.selectionRange.pipe(P.b(100),E.h(!1))),assistantOpened:this.assistantState.view($t),textMapIsEmpty:this._params.integration.textMapIsEmpty,quickReplyContext:this._params.integration.quickReplyContext,availability:this._assistantServices.genAIAvailabilityService.availability,entryPointsEnabled:this._entryPointsEnabled,featureFlags:this._params.featureFlags})).pipe(y.U((({inlineButtonInfo:e,selectionRange:t,selectionOngoing:i,assistantOpened:s,textMapIsEmpty:a,quickReplyContext:r,availability:n,entryPointsEnabled:c,featureFlags:d})=>(0,o.zG)(e,U.filter((()=>c)),U.filter((()=>!s)),U.filter((()=>me._.isUsable(n))),U.fold(o.gn,(e=>(0,o.zG)(t,U.fold(o.gn,(t=>a&&U.isSome(r)&&d.inlineQuickReply?l.createElement(te,{disabled:!1,referenceElement:e.referenceElement,placement:e.placement,offset:U.toNullable(e.offset),onClick:()=>{this._inlineButtonRecentlyPressed.set(!0),this._openAssistantSubject.next(Mt(Ot(this._params.sharedAssistantTreatment),"quickReply",{kind:"inlineQuickReplySource"}))}}):ti(t)&&(d.inlineRewrite||d.magicRewrite)&&this._params.integration.enableInlineRewrites?l.createElement(ae,{disabled:i,referenceElement:e.referenceElement,placement:e.placement,offset:U.toNullable(e.offset),onOpenRewriteClick:d.inlineRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._openAssistantSubject.next(Mt(Ot(this._params.sharedAssistantTreatment),"rewrite",{kind:"inlineRewriteSource"}))}:void 0,onMagicRewriteClick:d.magicRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._openAssistantSubject.next(Mt(Ot(this._params.sharedAssistantTreatment),"quickRewrite",{kind:"inlineQuickRewriteSource"}))}:void 0}):null)))))))))}_getOnboardingUI(){const e=this._params.featureFlags.get().externalOnboardingContextProviderFix?X:$;return this._onboardingViewModels.view(U.fold(o.gn,(t=>l.createElement(e,null,N.UI.mount(be.T,(0,Se.A)(t))))))}_getHighlightUI(){return M.h.combine(this._highlights,this.assistantState.view($t),this._assistantFocused,((e,t,i)=>t&&i?e.map((({rect:e,visibility:t},i)=>l.createElement(F,{key:`cheetah-highlight-rect-${i}`,top:e.top,left:e.left,width:e.width,height:e.height,visibility:t}))):null))}_getQuasiCaretUI(){return M.h.combine(this._quasiCaretRect,this._params.experimentClient.isGateEnabled(he.K.UnfixFast570)?this.assistantState.view($t):this.assistantState.view(Xt),((e,t)=>(0,o.zG)(e,U.filter((()=>t)),U.fold((()=>null),(e=>l.createElement(ce,{left:e.left,top:e.top,height:e.height,overflow:this._params.integration.allowCustomCaretOverflow}))))))}_getIdeateButtonUI(){return M.h.combine(this._params.featureFlags,this._inlineButtonUI,this._selectionRange,this._params.integration.quickReplyContext,this._assistantServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((e,t,i,s,a,r)=>(0,o.zG)(t,U.fromPredicate((e=>null===e)),U.filter((()=>r&&e.ideateButton)),U.filter((()=>me._.isUsable(a))),U.fold(o.gn,(()=>this._getIdeateButtonForSelectionRange(i,s,e))))))}_getExpandedIdeateButtonUI(){return this._isMergedAssistantEnabled()?M.h.create(null):M.h.combine(this._params.featureFlags,this._selectionRange,this._params.integration.quickReplyContext,this._assistantServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((e,t,i,s,a)=>(0,o.zG)(s,U.fromPredicate((e=>me._.isVisible(e))),U.filter((()=>a&&e.ideateButton)),U.fold(o.gn,(()=>this._getIdeateButtonForSelectionRange(t,i,e))))))}_getIdeateButtonForSelectionRange(e,t,i){return this._isMergedAssistantEnabled()?null:(0,o.zG)(e,U.filter((e=>ti(e)&&i.rewrite)),U.fold((()=>ei(t)&&i.quickReply?"quickReply":i.compose?"ideation":null),(()=>"rewrite")),U.fromNullable,U.fold(o.gn,(e=>l.createElement(Kt,{onMouseEnter:()=>this._ideateButtonRecentlyHovered.set(!0),onMouseLeave:()=>this._ideateButtonRecentlyHovered.set(!1),onClick:()=>this._onClickIdeateButton(e),mount:e=>this._ideateButtonRefChange.next(e),forceTooltipMessage:this._ideateButtonTooltipNotificationState.view(U.toUndefined)}))))}_insertText(e){""!==e?this._params.integration.insertText(e,this._selectionRange.get()):this._log.warn("insert() - attempting to insert empty response, skipping insert.")}dispose(){var e,t;this._disposed.next(null),this._highlightsUpdater.dispose(),this._closeAssistant(ye.jg.disposed),null===(e=U.toUndefined((0,o.zG)(this._onboardingViewModels.get(),U.map((e=>e.onboarding)))))||void 0===e||e.dispose(),this._assistantServices.dispose(),null===(t=this._assistantApplet.get())||void 0===t||t.dispose(),this._subs.unsubscribe(),(0,o.zG)(this._nativeCursorHider.get(),O.bw((e=>e.dispose()))),this._params.integration.dispose()}}function ei(e){return(0,o.zG)(e,U.exists((e=>Object.values(e).filter((e=>void 0!==e)).length>0)))}function ti(e){const t=e.end-e.start;return t>=10&&t<5e3}function ii(e){return(0,B.W9)(_e.l.is(_e.l.Kind.mount),(e=>e.step===ve.T.StepName.initial))(e)}function si(e){return(0,B.W9)(_e.l.is(_e.l.Kind.mount),(e=>e.step===ve.T.StepName.initialBTS))(e)}},32065:(e,t,i)=>{i.d(t,{P:()=>E});var s=i(57050),a=i(54696),r=i(32104),n=i(46297);class o{constructor(e,t=[n.$x]){this._doc=e,this._styleEl=this._doc.createElement("STYLE"),this._styleEl.innerHTML=t.map((e=>`${e}{opacity:0 !important;}`)).join("\n"),this._doc.head.appendChild(this._styleEl)}dispose(){this._styleEl.remove()}}var l=i(14595),c=i(55649),d=i(66310),u=i(23063),p=i(77176),h=i(85985),g=i(2768),m=i(93508),v=i(76974),_=i(19751),f=i(598),b=i(5114),S=i(72010),y=i(68919),A=i(89456),w=i(62874),I=i(27378),C=i(8543);const R=({children:e,position:t,beforeElement:i})=>I.createElement(C.F.Fragment,null,t.pipe(p.U((t=>I.createElement("div",{key:"assistant-container",style:{display:"flex",flexDirection:"column",position:"fixed",top:t.top,bottom:t.bottom,left:t.left,right:t.right,width:t.width,height:t.height}},i?I.createElement(i,null):void 0,I.createElement("div",{style:{flexGrow:1,minHeight:0}},e({sizeBehavior:v.of({heightBehavior:{kind:"fitContainer"},widthBehavior:{kind:"fitContainer"}}),dragBehavior:v.of({kind:"notDraggable"}),readyToDrag:()=>Promise.resolve(void 0)})))))));var x=i(85441),k=i(9205);function P(){return I.createElement("div",{style:{fontSize:"12px",padding:"12px 16px 4px 16px",backgroundColor:"white"}},"Internal Only")}class E extends S.B{constructor({selectionService:e,selectionSource:t,cursorTracker:i,...s}){super({...s,selectionOrCaretPosition:U(s.textObserver,i,e,t),docContextUpdatedEvents:b.none,allowCustomCaretOverflow:!1,focusTextField:()=>s.textField.click(),logger:c.Y.create("CheetahIntegrationGDocsCanvas")}),this._sidebarPosition=s.sidebarPosition,this._scroller=(0,y.z)(s.textObserver,s.textFieldLayout,s.userInputShutOff),this._isDocOwnedByCurrentUser=s.isDocOwnedByCurrentUser}_scrollToRenderedRect(e){const t=A.Pf.create(e),i=this._textFieldLayout.visibleRect.getApproximate().client.top-this._textFieldLayout.rect.getApproximate().client.top;this._scroller.scrollToRect(t,i)}_scrollToUnrenderedHighlight(e){this._scroller.scrollToRange(e.start).pipe(d.w((t=>w.S.hz30.pipe(u.q(9),d.w((()=>this.getHighlightRects(e))),p.U((e=>null==e?void 0:e[0])),h.h((e=>!!e)),u.q(1)))),g.R(this._disposed)).subscribe((e=>{this._scrollToRenderedRect(e)}))}isDocOwnedByCurrentUser(){return this._isDocOwnedByCurrentUser}scrollHighlightIntoView(e){this.getHighlightRects(e).pipe(p.U((e=>null==e?void 0:e[0])),u.q(1),g.R(this._disposed)).subscribe((t=>{t?this._scrollToRenderedRect(t):this._scrollToUnrenderedHighlight(e)}))}createNativeUIHider(){return new o(document)}renderAssistant(e,t){return"genAI"===t||"genAIAndWritingExpert"===t?super.renderAssistant(e,t):Promise.resolve(((e,t,i)=>I.createElement(R,{position:t,beforeElement:i},e))(e,this._sidebarPosition,(0,x.OB)().experimentClient.isGateEnabled(k.K.CheetahMergedWithGDocsInternalLabel)?P:function(){return null}))}canResizeAssistant(e){return"genAI"===e||"genAIAndWritingExpert"===e}get isPlagiarismEnabled(){return(0,x.OB)().experimentClient.isGateEnabled(k.K.SharedAssistantPlagiarismGDocs)}get isWritingExpertEnabled(){return(0,x.OB)().experimentClient.isGateEnabled(k.K.WritingExpertPullMode)}dispose(){this._scroller.dispose(),super.dispose()}}function U(e,t,i,n){return n.data.behavior.pipe(m.O(null),d.w((()=>(0,s.zG)(i.getCurrentSelection(!0),r.Ls,b.fromNullable,b.filter((0,s.ff)(a.SV.isCollapsed)),b.fold((()=>function(e,t){return e.contentChanges.async.pipe(m.O(null),f.c(t.offsetPosition.pipe(p.U((0,s.ls)(b.fromNullable,b.chain((t=>{const i=e.getCurrentTextMap();if(i.isEmpty())return b.some(0);const a=2,r=1;return(0,s.zG)(b.fromNullable(i.getPageContainingOffsetPoint(t)),b.chain((e=>b.fromNullable((0,s.zG)((0,l.W)({top:t.top-r/2-e.getPageRect().top,left:t.left-a/2-e.getPageRect().left,width:a,height:r},e.getPageInnerSize(),e.getPageRect()),(t=>{var i,s;return null===(s=null===(i=e.getTextRangeInInnerRect)||void 0===i?void 0:i.call(e,t))||void 0===s?void 0:s.startOffset}))))))})))))))}(e,t).pipe(p.U(b.map(a.SV.create)))),(e=>v.of(b.some(e))))))),_.skipBy(b.getEq(a.SV.eq)))}},32057:(e,t,i)=>{i.d(t,{V:()=>s});i(92310);const s=/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|[\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|[\ud83c[\ude32-\ude3a]|[\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/g},46297:(e,t,i)=>{i.d(t,{$x:()=>n,F8:()=>g,Go:()=>a,Kt:()=>y,Lq:()=>c,Q2:()=>b,QR:()=>x,Qy:()=>_,Vk:()=>A,Wp:()=>s,XG:()=>r,_m:()=>p,d0:()=>d,f:()=>l,gH:()=>v,gL:()=>w,gv:()=>m,ij:()=>R,j5:()=>S,jW:()=>h,lO:()=>C,os:()=>f,rx:()=>I,uj:()=>u,y1:()=>o});const s=".kix-appview-editor",a=".docos-input",r=".docs-texteventtarget-iframe",n=".kix-cursor",o=".kix-cursor-caret",l="#docs-revisions-sidebar",c='#docs-toolbar-mode-switcher[aria-label="Viewing mode"]',d="#docs-toolbar-mode-switcher",u="edit-mode",p="suggest-mode",h="#titlebar-mode-indicator-container .titlebar-request-access-button",g="#titlebar-mode-indicator-container .kix-titlebar-request-access-button",m=".kix-canvas-tile-content",v="canvas.kix-canvas-tile-content:not(.docs-ui-unprintable *)",_=".kix-rotatingtilemanager:not(.docs-ui-unprintable *)",f=".kix-page-paginated.canvas-first-page",b="kix-page-canvas-compact-mode",S=".docs-horizontal-ruler",y=".docs-vertical-ruler",A="#fontSizeSelect input",w=".docs-ruler-background",I=".docs-ruler-background-inner",C=".docs-ruler-indent-first-line",R=".modal-dialog.docs-dialog .fatal-error-message",x='#docs-titlebar-share-client-button div[role="button"]'},88571:(e,t,i)=>{i.d(t,{Q:()=>l});var s=i(27378),a=i(15073),r=i(60797),n=i(95300),o=i(5114);const l=({children:e,remSize:t,setter:i})=>(c+=1,s.useEffect((()=>{const e=t.subscribe((e=>{d.next(o.some(e)),i(o.some(e))}));return()=>{e.unsubscribe(),c-=1,0===c&&(d.next(o.none),i(o.none))}}),[t]),s.createElement(a.u.Context.Provider,{value:d.pipe(r.oA)},e));let c=0;const d=new n.X(o.none)},14595:(e,t,i)=>{i.d(t,{W:()=>v,t:()=>g});var s=i(17771),a=i(40327);if(3075==i.j)var r=i(68435);if(3075==i.j)var n=i(89456);if(3075==i.j)var o=i(70063);var l=i(46297),c=i(50756),d=i(5114),u=i(83078);if(3075==i.j)var p=i(71249);const h={getCursorRect:()=>(0,a.pipe)(d.fromNullable(document.querySelector(l.y1)),d.map((e=>e.getBoundingClientRect())),d.toNullable),getCanvasRect:()=>(0,a.pipe)(d.fromNullable(document.querySelector(l.os)),d.alt((()=>d.fromNullable(document.querySelector(l.gH)))),d.map((e=>e.getBoundingClientRect())),d.toNullable),getFirstLineIndentEl:e=>e.querySelector(l.lO),getFontSizeInputEl:()=>document.querySelector(l.Vk),getRulerBackgroundsRects:e=>(0,a.pipe)(s.Y(d.option)({backgroundRect:(0,a.pipe)(d.fromNullable(e.querySelector(l.gL)),d.map((e=>e.getBoundingClientRect()))),innerBackgroundRect:(0,a.pipe)(d.fromNullable(e.querySelector(l.rx)),d.map((e=>e.getBoundingClientRect())))}),d.toNullable),withVisibleRulers:e=>{const t=(0,a.pipe)(s.Y(d.option)({horizontalRuler:d.fromNullable(document.querySelector(l.j5)),verticalRuler:d.fromNullable(document.querySelector(l.Kt))}),d.map((({horizontalRuler:e,verticalRuler:t})=>({horizontalRuler:{node:e,opacity:e.style.opacity,display:e.style.display},verticalRuler:{node:t,opacity:t.style.opacity,display:t.style.display}}))),u.bw((({horizontalRuler:e,verticalRuler:t})=>{"none"===e.display&&(e.node.style.opacity="0",e.node.style.removeProperty("display")),"none"===t.display&&(t.node.style.opacity="0",t.node.style.removeProperty("display"))})));try{return e((0,a.pipe)(t,d.map((({verticalRuler:e})=>e.node)),d.toNullable),(0,a.pipe)(t,d.map((({horizontalRuler:e})=>e.node)),d.toNullable))}finally{(0,a.pipe)(t,u.bw((({horizontalRuler:e,verticalRuler:t})=>{e.node.style.display=e.display,e.node.style.opacity=e.opacity,t.node.style.display=t.display,t.node.style.opacity=t.opacity})))}}};class g{constructor(e,t,i=h){this._layoutRoot=e,this._telemetry=t,this._gDocsDOM=i}create(e,t){try{if(t.isEmpty()&&0===e.start&&0===e.end)return{rects:(0,a.pipe)(d.fromNullable(t.getPageContainingOffset(0)),d.chain((e=>(0,a.pipe)(d.fromNullable(this._gDocsDOM.getCursorRect()),d.filter((e=>e.left>0&&e.top>0&&e.height>0)),d.chain((e=>s.Y(d.option)({rect:d.some(e),canvasRect:d.fromNullable(this._gDocsDOM.getCanvasRect())}))),d.map((({rect:t,canvasRect:i})=>[n.Wm.create(n.UL.shift(n.UL.shift(n.Pf.create(t),o.E9.minus({left:0,top:0},i)),e.getPageRect()))])),d.alt((()=>d.fromNullable(this._gDocsDOM.withVisibleRulers(((t,i)=>(0,a.pipe)(s.Y(d.option)({horizontalRuler:d.fromNullable(i),verticalRuler:d.fromNullable(t),lineHeight:(0,a.pipe)(d.fromNullable(this._gDocsDOM.getFontSizeInputEl()),d.map((e=>parseInt(e.value,10))),d.filter((e=>!isNaN(e))),d.map((e=>1.533*e)))}),d.chain((({horizontalRuler:e,verticalRuler:t,lineHeight:i})=>s.Y(d.option)({firstLineIndent:(0,a.pipe)(d.fromNullable(this._gDocsDOM.getFirstLineIndentEl(e)),d.map((e=>e.offsetLeft+e.offsetWidth/2))),topMargin:(0,a.pipe)(d.fromNullable(this._gDocsDOM.getRulerBackgroundsRects(t)),d.map((({backgroundRect:e,innerBackgroundRect:t})=>t.top-e.top+i)))}))),d.map((({firstLineIndent:t,topMargin:i})=>[n.Wm.create(n.UL.shift({left:t,top:i,height:0,width:0},e.getPageRect()))])),d.toNullable))))))))),d.getOrElse((()=>[])))};const i=[];let r,l=e.start,c=!1;do{const s=t.getFragmentAtOffset(l);if(s&&r!==l){r=l;const t=s.getFragmentInnerRect(l>s.startOffset?l-s.startOffset:0,e.end<s.endOffset?e.end-s.startOffset:void 0),a=s.getPage(),o=a.getPageRect(),c=n.Wm.create(n.UL.shift(m(t,a.getPageInnerSize(),o),o));i.push(c),l=s.endOffset}else c=!0}while(l<e.end&&!c);return{rects:i}}catch(e){throw this._telemetry.error("geometryProvider","exception in create method",e),e}}getClientRects(e){try{const t=this._layoutRoot.getClientRects().item(0);if(t){const i={top:this._layoutRoot.scrollTop,left:this._layoutRoot.scrollLeft};return(0,a.pipe)(e.rects,r.es,r.yX,p.UI((e=>n.UL.setPosition(o.Ir.fromOffsetPoint(o.p8.create(e),o.Ir.create(t),i),e))))}return null}catch(e){return this._telemetry.error("geometryProvider","exception in getClientRects method",e),null}}getIsInvalid(e){return!1}getIsConsistent(e,t,i){return!0}dispose(e){}}function m(e,t,i){const s=i.width/t.width,a=i.height/t.height;return{left:e.left*s,top:e.top*a,width:e.width*s,height:e.height*a}}function v(e,t,i){const s=t.width/i.width,a=t.height/i.height;return(0,c.cl)({left:e.left*s,top:e.top*a,width:e.width*s,height:e.height*a})}},68919:(e,t,i)=>{i.d(t,{z:()=>m});var s=i(32952),a=i(12126),r=i(2834),n=i(66310),o=i(23063),l=i(85985),c=i(2768),d=i(17343),u=i(40151),p=i(93508),h=i(77176),g=i(19751);function m(e,t,i,m=3e3){const v=new s.xQ,_=new s.xQ;const f=v.pipe(n.w((t=>null==t?u.E:e.contentChanges.async.pipe(p.O(0),c.R(_.pipe(h.U((e=>e===t)))),c.R(i),d.h(t),c.R(g.timer(m).pipe(r.b((e=>{})))))))).subscribe((i=>{const s=e.getCurrentTextMap(),a=s.getNearestPageFragmentAtOrBeforeOffset(i);if(a){if(a.startOffset<=i&&a.endOffset>=i)return void _.next(i);if(a.endOffset<i){const e=a.getPageRect(),i=t.visibleRect.getApproximate(),s=t.rect.getApproximate().client.top+e.top+e.height-i.client.top-i.size.height;if(s>0)return void requestAnimationFrame((()=>{t.scroller.scrollBy({left:0,top:s})}))}}const r=s.getNearestPageFragmentAfterOffset(i);if(r&&r.startOffset>i){const e=r.getPageRect(),i=t.visibleRect.getApproximate(),s=t.rect.getApproximate().client.top+e.top-i.client.top;if(s<0)return void requestAnimationFrame((()=>{t.scroller.scrollBy({left:0,top:s})}))}}));return{scrollToRect:function(e,i){v.next(null);const s=t.visibleRect.getApproximate();i<=e.top&&e.bottom<=i+s.size.height||t.scroller.scrollBy({top:e.top-i-100})},scrollToRange:function(e){return a.D([0]).pipe(r.b((()=>v.next(e))),n.w((e=>_)),o.q(1),l.h((t=>t===e)),c.R(v.pipe(l.h((t=>t!==e)))),d.h(void 0))},dispose:function(){f.unsubscribe(),v.complete(),_.complete()}}}},50756:(e,t,i)=>{function s(e){return e}function a(e){return e}i.d(t,{Ps:()=>a,cl:()=>s})},57757:(e,t,i)=>{i.d(t,{Sz:()=>r,vQ:()=>a});var s=i(95195);async function a(e,t=self){if(function(e=self){var t,i;return!!(null===(i=null===(t=e.navigator)||void 0===t?void 0:t.clipboard)||void 0===i?void 0:i.writeText)}(t))return t.navigator.clipboard.writeText(e);throw new Error("Clipboard API not supported")}function r(e,t=self){return a(e,t).then((()=>s.right(void 0))).catch((e=>s.left(e instanceof Error?e:new Error(String(e)))))}},51325:e=>{e.exports={highlightRect:"XWxTA",hidden:"o979x",attention:"bHjcD",blink:"oy7wj"}},87491:e=>{e.exports={entryButton:"cDocn",entryButtonItem:"dJCJe",rewriteIcon:"wGNWN",openIcon:"vIUqu",spin:"A8MjA"}},50783:e=>{e.exports={replyButton:"ZfD1U",icon:"BdxRh",spin:"MBS28"}},48033:e=>{e.exports={quasiCaret:"WhbAl",icon:"Yd_W5"}}}]);